<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>4. Fit and Explore Selected Models • kuenm2</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="4. Fit and Explore Selected Models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">kuenm2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.11</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-book"></span> Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/basic_data_cleaning.html">1. Basic Data Cleaning</a></li>
    <li><a class="dropdown-item" href="../articles/prepare_data.html">2. Prepare Data for Model Calibration</a></li>
    <li><a class="dropdown-item" href="../articles/model_calibration.html">3. Model Calibration</a></li>
    <li><a class="dropdown-item" href="../articles/model_exploration.html">4. Fit and Explore Selected Models</a></li>
    <li><a class="dropdown-item" href="../articles/model_predictions.html">5. Project Models to a Single Scenario</a></li>
    <li><a class="dropdown-item" href="../articles/model_projections.html">6. Project Models to Multiple Scenarios</a></li>
    <li><a class="dropdown-item" href="../articles/variability_and_uncertainty.html">7. Exploring Model Uncertainty and Variability</a></li>
    <li><a class="dropdown-item" href="../articles/projections_chelsa.html">8. Example of Projections Using CHELSA Data</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/marlonecobos/kuenm2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>4. Fit and Explore Selected Models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/marlonecobos/kuenm2/blob/main/vignettes/model_exploration.Rmd" class="external-link"><code>vignettes/model_exploration.Rmd</code></a></small>
      <div class="d-none name"><code>model_exploration.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#getting-ready">Getting ready</a></li>
<li><a href="#fitting-selected-models">Fitting selected models</a></li>
<li>
<a href="#response-curves">Response curves</a>
<ul>
<li><a href="#all-response-curves">All response curves</a></li>
<li><a href="#customized-response-curves">Customized response
curves</a></li>
<li><a href="#bivariate-response-curves">Bivariate response
curves</a></li>
</ul>
</li>
<li><a href="#variable-importance">Variable importance</a></li>
<li><a href="#model-evaluation-with-independent-data">Model evaluation
with independent data</a></li>
<li><a href="#saving-a-fitted_models-object">Saving a fitted_models
object</a></li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="description">Description<a class="anchor" aria-label="anchor" href="#description"></a>
</h2>
<p>After the best performing models have been selected, users need to
fit this models (using <code><a href="../reference/fit_selected.html">fit_selected()</a></code>) in order to explore
their characteristics and continue with the next steps. Fitted models
can then be used to assess variable importance in models, as well as to
explore variable response curves. Selected models can also be evaluated
using independent records that were not used during calibration. This
vignettes contains examples to explore the multiple options available to
fit and explore selected models.</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="getting-ready">Getting ready<a class="anchor" aria-label="anchor" href="#getting-ready"></a>
</h2>
<p>At this point it is assumed that <code>kuenm2</code> is installed (if
not, see the <a href="../index.html">Main guide</a>). Load
<code>kuenm2</code> and any other required packages, and define a
working directory (if needed).</p>
<p>Note: functions from other packages (i.e., not from base R or
<code>kuenm2</code>) used in this guide will be displayed as
<code>package::function()</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marlonecobos.github.io/kuenm2/">kuenm2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Current directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define new directory</span></span>
<span><span class="co">#setwd("YOUR/DIRECTORY")  # uncomment and modify if setting a new directory</span></span>
<span></span>
<span><span class="co"># Saving original plotting parameters</span></span>
<span><span class="va">original_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>no.readonly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
</div>
<div class="section level2">
<h2 id="fitting-selected-models">Fitting selected models<a class="anchor" aria-label="anchor" href="#fitting-selected-models"></a>
</h2>
<p>To fit the selected models, we need a
<code>calibration_results</code> object. For more details in model
calibration, please refer to the vignette <a href="model_calibration.html">Model Calibration</a>. The
<code>calibration_results</code> object generated in this vignette is
available as a data example in the package. Let’s load it.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import an example of calibration results </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"calib_results_maxnet"</span>, package <span class="op">=</span> <span class="st">"kuenm2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print calibration result</span></span>
<span><span class="va">calib_results_maxnet</span></span>
<span><span class="co">#&gt; calibration_results object summary (maxnet)</span></span>
<span><span class="co">#&gt; =============================================================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of candidate models: 300 </span></span>
<span><span class="co">#&gt;   - Models removed because they failed to fit: 0 </span></span>
<span><span class="co">#&gt;   - Models identified with concave curves: 39 </span></span>
<span><span class="co">#&gt;   - Model with concave curves not removed </span></span>
<span><span class="co">#&gt;   - Models removed with non-significant values of pROC: 0 </span></span>
<span><span class="co">#&gt;   - Models removed with omission error &gt; 10%: 165 </span></span>
<span><span class="co">#&gt;   - Models removed with delta AIC &gt; 2: 133 </span></span>
<span><span class="co">#&gt; Selected models: 2 </span></span>
<span><span class="co">#&gt;   - Up to 5 printed here:</span></span>
<span><span class="co">#&gt;      ID</span></span>
<span><span class="co">#&gt; 192 192</span></span>
<span><span class="co">#&gt; 219 219</span></span>
<span><span class="co">#&gt;                                                                                      Formulas</span></span>
<span><span class="co">#&gt; 192                        ~bio_1 + bio_7 + bio_15 + I(bio_1^2) + I(bio_7^2) + I(bio_15^2) -1</span></span>
<span><span class="co">#&gt; 219 ~bio_1 + bio_7 + bio_12 + bio_15 + I(bio_1^2) + I(bio_7^2) + I(bio_12^2) + I(bio_15^2) -1</span></span>
<span><span class="co">#&gt;     Features R_multiplier pval_pROC_at_10.mean Omission_rate_at_10.mean</span></span>
<span><span class="co">#&gt; 192       lq          0.1                    0                   0.0769</span></span>
<span><span class="co">#&gt; 219       lq          0.1                    0                   0.0962</span></span>
<span><span class="co">#&gt;         dAIC Parameters</span></span>
<span><span class="co">#&gt; 192 0.000000          6</span></span>
<span><span class="co">#&gt; 219 1.179293          7</span></span></code></pre></div>
<p><br></p>
<p>This object contains the results of candidate models calibrated using
the <code>maxnet</code> algorithm. The package also provides a similar
example wit models created using the <code>glm</code> algorithm. See
below how to load the <code>calib_results_glm</code> object in case you
want to explore it.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import calib_results_glm</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"calib_results_glm"</span>, package <span class="op">=</span> <span class="st">"kuenm2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print calibration result</span></span>
<span><span class="va">calib_results_glm</span></span>
<span><span class="co">#&gt; calibration_results object summary (glm)</span></span>
<span><span class="co">#&gt; =============================================================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of candidate models: 122 </span></span>
<span><span class="co">#&gt;   - Models removed because they failed to fit: 0 </span></span>
<span><span class="co">#&gt;   - Models identified with concave curves: 18 </span></span>
<span><span class="co">#&gt;   - Model with concave curves not removed </span></span>
<span><span class="co">#&gt;   - Models removed with non-significant values of pROC: 0 </span></span>
<span><span class="co">#&gt;   - Models removed with omission error &gt; 10%: 101 </span></span>
<span><span class="co">#&gt;   - Models removed with delta AIC &gt; 2: 20 </span></span>
<span><span class="co">#&gt; Selected models: 1 </span></span>
<span><span class="co">#&gt;   - Up to 5 printed here:</span></span>
<span><span class="co">#&gt;    ID                                                        Formulas Features</span></span>
<span><span class="co">#&gt; 85 85 ~bio_1 + bio_7 + bio_12 + I(bio_1^2) + I(bio_7^2) + I(bio_12^2)       lq</span></span>
<span><span class="co">#&gt;    pval_pROC_at_10.mean Omission_rate_at_10.mean dAIC Parameters</span></span>
<span><span class="co">#&gt; 85                    0                   0.0904    0          6</span></span></code></pre></div>
<p><br></p>
<p>Note that the <code>calibration_results</code> object stores only the
information related to the calibration process and model evaluation, it
does not include the fitted <code>maxnet</code> (or <code>glm</code>)
models.</p>
<p>To obtain fitted models, we need to use the
<code><a href="../reference/fit_selected.html">fit_selected()</a></code> function. By default, this function fits a
full model (i.e., without replicates and without splitting the data into
training and testing sets). However, you can configure it to fit final
models with replicates if desired.</p>
<p>In this example, we’ll fit the final models with 4 k-fold replicates
(leaving one fold out), as in the <a href="model_calibration.html">Model
Calibration</a> vignette.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit selected models using calibration results</span></span>
<span><span class="va">fm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_selected.html">fit_selected</a></span><span class="op">(</span>calibration_results <span class="op">=</span> <span class="va">calib_results_maxnet</span>, </span>
<span>                   replicate_method <span class="op">=</span> <span class="st">"kfolds"</span>, n_replicates <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co"># Fitting replicates...</span></span>
<span><span class="co">#   |========================================================================| 100%</span></span>
<span><span class="co"># Fitting full models...</span></span>
<span><span class="co">#   |========================================================================| 100%</span></span></code></pre></div>
<p><br></p>
<p>The <code><a href="../reference/fit_selected.html">fit_selected()</a></code> function returns a
<code>fitted_models</code> object, a list that contains essential
information from the fitted models, which is required for the subsequent
steps.</p>
<p>You can explore the contents of the <code>fitted_models</code> object
by indexing its elements. For example, the fitted <code>maxnet</code>
(or <code>glm</code>) model objects are stored within the
<code>Models</code> element. Note that <code>Models</code> is a nested
list: for each selected model (in this case, models 192 and 219), it
includes both the replicates (if fitted with replicates) and the full
model.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># See names of selected models</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fm</span><span class="op">$</span><span class="va">Models</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Model_192" "Model_219"</span></span>
<span></span>
<span><span class="co"># See models inside Model 192</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fm</span><span class="op">$</span><span class="va">Models</span><span class="op">$</span><span class="va">Model_192</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Replicate_1" "Replicate_2" "Replicate_3" "Replicate_4" "Full_model"</span></span></code></pre></div>
<p><br></p>
<p>The <code>fitted_models</code> object also stores the thresholds that
can be used to binarize the models into suitable and unsuitable areas.
These thresholds correspond to the omission error used during model
selection (e.g., 5% or 10%).</p>
<p>You can access the omission error used to calculate the thresholds
directly from the object:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get omission error used to select models and calculate the theshold values</span></span>
<span><span class="va">fm</span><span class="op">$</span><span class="va">omission_rate</span></span>
<span><span class="co">#&gt; [1] 10</span></span></code></pre></div>
<p><br></p>
<p>The omission error used to calculate the thresholds was 10%, meaning
that when the predictions are binarized, approximately 10% of the
presence records used to calibrate the models will fall into cells with
predicted values below the threshold.</p>
<p>The thresholds are summarized in two ways: the mean and median across
replicates for each model, and the consensus mean and median across all
selected models (when more than one model is selected):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fm</span><span class="op">$</span><span class="va">thresholds</span></span>
<span><span class="co">#&gt; $Model_192</span></span>
<span><span class="co">#&gt; $Model_192$mean</span></span>
<span><span class="co">#&gt; [1] 0.2449115</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $Model_192$median</span></span>
<span><span class="co">#&gt; [1] 0.266498</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $Model_219</span></span>
<span><span class="co">#&gt; $Model_219$mean</span></span>
<span><span class="co">#&gt; [1] 0.260294</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $Model_219$median</span></span>
<span><span class="co">#&gt; [1] 0.2695625</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $consensus</span></span>
<span><span class="co">#&gt; $consensus$mean</span></span>
<span><span class="co">#&gt; [1] 0.2526028</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $consensus$median</span></span>
<span><span class="co">#&gt; [1] 0.2680302</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $type</span></span>
<span><span class="co">#&gt; [1] "cloglog"</span></span></code></pre></div>
<p><br></p>
</div>
<div class="section level2">
<h2 id="response-curves">Response curves<a class="anchor" aria-label="anchor" href="#response-curves"></a>
</h2>
<p>The selected models in the <code>fitted_models</code> object can be
used to generate response curves. Individual variable response curves
illustrate how each environmental variables influences suitability,
while keeping all other variables constant.</p>
<p>By default, the curves are generated with all other variables set to
their mean values (or the mode for categorical variables). The mean or
mode are calculated from the combined set of presence and background
data (<code>averages_from = "pr_bg"</code>). You can change this
behavior to use only the presence localities by setting
<code>averages_from = "pr"</code>.</p>
<p><br></p>
<div class="section level3">
<h3 id="all-response-curves">All response curves<a class="anchor" aria-label="anchor" href="#all-response-curves"></a>
</h3>
<p>An easy way to explore response curves for all variables is as
follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Produce response curves for all variables in all fitted models</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">all_response_curves</a></span><span class="op">(</span><span class="va">fm</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/all%20var%20resps-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
<p>In the previous plot, the dashed lines indicate the range of
variables values in the data used to fit models. If multiple models were
fitted, variability is shown via a Generalized Additive Model (GAM)
using the mean and the 95% confidence interval. For a more detailed view
of what the response curve for each of the models fitted look like, the
argument <code>show_lines</code> can be set to <code>TRUE</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># All response curves showing each model as a different line</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">all_response_curves</a></span><span class="op">(</span><span class="va">fm</span>, show_lines <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/all%20var%20resps1-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
<p>To explore response curves of all variables for each model
independently, the argument <code>model_ID</code> can be used. The plot
will show variable response curves for the full model.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># All response curves for model 219</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">all_response_curves</a></span><span class="op">(</span><span class="va">fm</span>, modelID <span class="op">=</span> <span class="st">"Model_219"</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/all%20var%20resps2-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
<p>To get a view of variability in response curves for a model produced
with replicates, use <code>show_variability = TRUE</code>. Both, the GAM
or the multiple-line approaches can be used to show variability.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># All response curves for model 219 (GAM for variability)</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">all_response_curves</a></span><span class="op">(</span><span class="va">fm</span>, modelID <span class="op">=</span> <span class="st">"Model_219"</span>, show_variability <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/all%20var%20resps3-1.png" class="r-plt" alt="" width="672"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># All response curves for model 219 (each curve is a replicate)</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">all_response_curves</a></span><span class="op">(</span><span class="va">fm</span>, modelID <span class="op">=</span> <span class="st">"Model_219"</span>, show_variability <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                    show_lines <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/all%20var%20resps3-2.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="customized-response-curves">Customized response curves<a class="anchor" aria-label="anchor" href="#customized-response-curves"></a>
</h3>
<p>The previous plots help to gain a quick understanding of response
curves for fitted models, but little can be done make each panel look
better. To produce nicer plots, response curves for each variable at a
time can be produced. Let’s check which variables are available to plot
by examining the coefficients of the full models:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get variables with non-zero coefficients in the models</span></span>
<span><span class="va">fm</span><span class="op">$</span><span class="va">Models</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Full_model</span><span class="op">$</span><span class="va">betas</span>  <span class="co"># From the first model selected</span></span>
<span><span class="co">#&gt;        bio_1        bio_7       bio_15   I(bio_1^2)   I(bio_7^2)  I(bio_15^2) </span></span>
<span><span class="co">#&gt; 11.572321659  0.215970079  0.369077970 -0.356605446 -0.020306099 -0.006200151</span></span>
<span><span class="va">fm</span><span class="op">$</span><span class="va">Models</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Full_model</span><span class="op">$</span><span class="va">betas</span>  <span class="co"># From the second model selected</span></span>
<span><span class="co">#&gt;         bio_1        bio_12        bio_15    I(bio_1^2)    I(bio_7^2) </span></span>
<span><span class="co">#&gt;  1.178814e+01  1.638570e-02  3.406100e-01 -3.625405e-01 -1.440450e-02 </span></span>
<span><span class="co">#&gt;   I(bio_12^2)   I(bio_15^2) </span></span>
<span><span class="co">#&gt; -5.261860e-06 -5.623987e-03</span></span></code></pre></div>
<p><br></p>
<p>The variables <code>bio_1</code>, <code>bio_7</code>,
<code>bio_12</code> and <code>bio_15</code>have non-zero coefficient
values, which means they contribute to the model and are available for
generating response curves.</p>
<p>Remember that response curves are computed using all selected models.
This time let’s change the margins and labels for each plot</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Set grid of plot</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_1"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_7"</span>, ylab <span class="op">=</span> <span class="st">""</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_12"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_15"</span>, ylab <span class="op">=</span> <span class="st">""</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/response%20curve-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
<p>We can also specify which of the selected models should be used to
generate the response curves:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">2.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Set grid of plot</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_1"</span>, modelID <span class="op">=</span> <span class="st">"Model_192"</span>, </span>
<span>               main <span class="op">=</span> <span class="st">"Model_192"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_1"</span>, modelID <span class="op">=</span> <span class="st">"Model_219"</span>, </span>
<span>               main <span class="op">=</span> <span class="st">"Model_219"</span>, ylab <span class="op">=</span> <span class="st">""</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_7"</span>, modelID <span class="op">=</span> <span class="st">"Model_192"</span>, </span>
<span>               main <span class="op">=</span> <span class="st">"Model_192"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_7"</span>, modelID <span class="op">=</span> <span class="st">"Model_219"</span>, </span>
<span>               main <span class="op">=</span> <span class="st">"Model_219"</span>, ylab <span class="op">=</span> <span class="st">""</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/response%20ID-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
<p>By default, the response curve extends beyond the range of model
fitting limits (dashed lines) based on the observed range of values and
an <code>extrapolation_factor</code> (when
<code>extrapolation = TRUE</code>). The default extrapolation factor is
set to 10% of the range.</p>
<p>If <code>extrapolation = FALSE</code>, no extrapolation occurs, and
the plot limits match the fitting data range exactly.</p>
<p>We can increase the extrapolation factor to allow a broader range
beyond the observed data. Below is the response curve plotted with an
extrapolation factor of 2:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Set grid of plot</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_1"</span>, extrapolation_factor <span class="op">=</span> <span class="fl">2</span>, </span>
<span>               las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_7"</span>, extrapolation_factor <span class="op">=</span> <span class="fl">2</span>,</span>
<span>               ylab <span class="op">=</span> <span class="st">""</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_12"</span>, extrapolation_factor <span class="op">=</span> <span class="fl">2</span>,</span>
<span>               las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_15"</span>, extrapolation_factor <span class="op">=</span> <span class="fl">2</span>,</span>
<span>               ylab <span class="op">=</span> <span class="st">""</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/extrapolation%20factor-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
<p>Note that the response curve now extends further beyond the observed
data range. Optionally, we can manually set the lower and upper limits
of the variables. For example, since <code>bio_12</code> represents
annual precipitation and negative values are not realistic, we can set
its lower limit to 0:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_12"</span>, extrapolation_factor <span class="op">=</span> <span class="fl">0.1</span>, </span>
<span>               l_limit <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/lower%20limit-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
<p>Now, the lower limit of the plot for <code>bio_12</code> is set to 0.
Since we did not specify an upper limit, the plot uses the extrapolation
factor (here, 0.1) to define the upper limit.</p>
<p>The other aspect to notice after increasing the extrapolation factor
is that the curves looked like they were not perfectly unimodal.
Unfortunately, using a GAM to summarize and represent variability can
some times generate this effect. However, plotting responses for each
model as independent curves will show the real shape of the curve, see
the differences after setting <code>show_lines = TRUE</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Set grid of plot</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_1"</span>, extrapolation_factor <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>               las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_1"</span>, extrapolation_factor <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>               show_lines <span class="op">=</span> <span class="cn">TRUE</span>, ylab <span class="op">=</span> <span class="st">""</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/GAM%20vs%20lines-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
<p>Optionally, we can add the presence and background points used to fit
the models to the response curve plot by setting
<code>add_points = TRUE</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/response_curve.html">response_curve</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable <span class="op">=</span> <span class="st">"bio_1"</span>, show_lines <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>               add_points <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/add%20points-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="bivariate-response-curves">Bivariate response curves<a class="anchor" aria-label="anchor" href="#bivariate-response-curves"></a>
</h3>
<p>All previous curve plots are showing responses to individual
variables. Exploring responses to two variables at a time can help
understand the small differences between models fitted with distinct
terms. Let’s see an example below:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First, let's check the terms in the models fitted</span></span>
<span><span class="co">## Model 192</span></span>
<span><span class="va">fm</span><span class="op">$</span><span class="va">Models</span><span class="op">$</span><span class="va">Model_192</span><span class="op">$</span><span class="va">Full_model</span><span class="op">$</span><span class="va">betas</span></span>
<span><span class="co">#&gt;        bio_1        bio_7       bio_15   I(bio_1^2)   I(bio_7^2)  I(bio_15^2) </span></span>
<span><span class="co">#&gt; 11.572321659  0.215970079  0.369077970 -0.356605446 -0.020306099 -0.006200151</span></span>
<span></span>
<span><span class="co">## Model 219</span></span>
<span><span class="va">fm</span><span class="op">$</span><span class="va">Models</span><span class="op">$</span><span class="va">Model_219</span><span class="op">$</span><span class="va">Full_model</span><span class="op">$</span><span class="va">betas</span></span>
<span><span class="co">#&gt;         bio_1        bio_12        bio_15    I(bio_1^2)    I(bio_7^2) </span></span>
<span><span class="co">#&gt;  1.178814e+01  1.638570e-02  3.406100e-01 -3.625405e-01 -1.440450e-02 </span></span>
<span><span class="co">#&gt;   I(bio_12^2)   I(bio_15^2) </span></span>
<span><span class="co">#&gt; -5.261860e-06 -5.623987e-03</span></span>
<span></span>
<span><span class="co"># Example of a bivariate response plot </span></span>
<span><span class="fu"><a href="../reference/bivariate_response.html">bivariate_response</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable1 <span class="op">=</span> <span class="st">"bio_1"</span>, variable2 <span class="op">=</span> <span class="st">"bio_15"</span>, </span>
<span>                   modelID <span class="op">=</span> <span class="st">"Model_192"</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/bivariate-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
<p>In the previous plot, the dashed lines represent the limits of the
data used for model fitting, and darker colors represent higher
suitability. Let’s now compare the two models and check if there are any
differences. Multiple bivariate response plots can be put together in a
single plot if the suitability bar legend is not used.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">2.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bivariate response model 192 </span></span>
<span><span class="fu"><a href="../reference/bivariate_response.html">bivariate_response</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable1 <span class="op">=</span> <span class="st">"bio_1"</span>, variable2 <span class="op">=</span> <span class="st">"bio_15"</span>, </span>
<span>                   modelID <span class="op">=</span> <span class="st">"Model_192"</span>, add_bar <span class="op">=</span> <span class="cn">FALSE</span>, main <span class="op">=</span> <span class="st">"Model 192"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bivariate response model 219 </span></span>
<span><span class="fu"><a href="../reference/bivariate_response.html">bivariate_response</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, variable1 <span class="op">=</span> <span class="st">"bio_1"</span>, variable2 <span class="op">=</span> <span class="st">"bio_15"</span>, </span>
<span>                   modelID <span class="op">=</span> <span class="st">"Model_219"</span>, add_bar <span class="op">=</span> <span class="cn">FALSE</span>, main <span class="op">=</span> <span class="st">"Model 219"</span>, </span>
<span>                   ylab <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/bivariate1-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
<p>These two models look very similar, the only noticeable difference is
that suitability values above the threshold extend farther on variable
bio_15 for model 219. More noticeable effects can be seen in bivariate
representations when fitted models include or not product terms.
However, as in this example, even a small variation on the number or
type of terms included in a model can change how predictions look
like.</p>
<p><br></p>
</div>
</div>
<div class="section level2">
<h2 id="variable-importance">Variable importance<a class="anchor" aria-label="anchor" href="#variable-importance"></a>
</h2>
<p>The relative importance of model predictors can be calculated
exploring the deviance using the <code>var_importance()</code> function.
This process starts by fitting the full model (<code>maxnet</code> or
<code>glm</code>), which includes all predictors. Then, the function
fits separate models excluding one predictor at a time, and quantifies
how the removal affects model performance. The values of contribution
are computed for variables by default, but explorations by terms are
also possible using the argument <code>by_terms</code> (i.e., if the
model includes linear and quadratic terms of a variable, the process
will run for each of them separately).</p>
<p>By default, the function runs on a single core. You can enable
parallel processing by setting <code>parallel = TRUE</code> and
specifying the number of cores with <code>ncores</code>. Note that
parallelization only speeds up the computation when there are many
variables (e.g., &gt;17) and the calibration dataset is large (e.g.,
over 15,000 total points).</p>
<p>Variable importance is computed for all selected models by
default:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate variable importance</span></span>
<span><span class="va">imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_importance.html">variable_importance</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculating variable contribution for model 1 of 2</span></span>
<span><span class="co">#   |======================================================================| 100%</span></span>
<span><span class="co"># Calculating variable contribution for model 2 of 2</span></span>
<span><span class="co">#   |======================================================================| 100%</span></span></code></pre></div>
<p><br></p>
<p>The function returns a <code>data.frame</code> with the relative
contribution of each variable. If multiple models are included in the
<code>fitted</code> object, an additional column identifies each
model.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">imp</span></span>
<span><span class="co">#&gt;   predictor contribution    Models</span></span>
<span><span class="co">#&gt; 1     bio_1  0.567815429 Model_192</span></span>
<span><span class="co">#&gt; 2    bio_15  0.219231619 Model_192</span></span>
<span><span class="co">#&gt; 3     bio_7  0.212952953 Model_192</span></span>
<span><span class="co">#&gt; 4     bio_1  0.721574882 Model_219</span></span>
<span><span class="co">#&gt; 5    bio_15  0.248819713 Model_219</span></span>
<span><span class="co">#&gt; 6    bio_12  0.025950948 Model_219</span></span>
<span><span class="co">#&gt; 7     bio_7  0.003654457 Model_219</span></span></code></pre></div>
<p><br></p>
<p>We can visualize variable importance using the
<code><a href="../reference/plot_importance.html">plot_importance()</a></code> function. When the
<code>fitted_models</code> object contains more than one selected model,
contributions are displayed as a boxplot, along with the mean
contribution, and the number (N) of fitted models with that
predictor.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_importance.html">plot_importance</a></span><span class="op">(</span><span class="va">imp</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/plot%20importance-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
<p>If variable importance is computed for a single model, the plot
displays a bars instead of boxes:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate variable importance for a specific selected Model</span></span>
<span><span class="va">imp_192</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_importance.html">variable_importance</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, modelID <span class="op">=</span> <span class="st">"Model_192"</span>, </span>
<span>                               progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot variable contribution for model 192</span></span>
<span><span class="fu"><a href="../reference/plot_importance.html">plot_importance</a></span><span class="op">(</span><span class="va">imp_192</span>, main <span class="op">=</span> <span class="st">"Variable importance: Model 192"</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/one%20model%20importance-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
<p>The previous examples show how important are variables by checking
the change in models if we remove a variable completely from the
equation. To compute contribution of all variable terms (i.e., how
important is to keep distinct terms of the same variable) set
<code>by_terms = TRUE</code>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate variable importance for a specific selected Model</span></span>
<span><span class="va">imp_terms</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_importance.html">variable_importance</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">fm</span>, by_terms <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                 progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Calculating variable contribution for model 1 of 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Calculating variable contribution for model 2 of 2</span></span>
<span></span>
<span><span class="co"># Check results</span></span>
<span><span class="va">imp_terms</span></span>
<span><span class="co">#&gt;      predictor contribution    Models</span></span>
<span><span class="co">#&gt; 1   I(bio_1^2)  0.330546900 Model_192</span></span>
<span><span class="co">#&gt; 2        bio_1  0.295001412 Model_192</span></span>
<span><span class="co">#&gt; 3       bio_15  0.209668355 Model_192</span></span>
<span><span class="co">#&gt; 4  I(bio_15^2)  0.156926301 Model_192</span></span>
<span><span class="co">#&gt; 5   I(bio_7^2)  0.006279520 Model_192</span></span>
<span><span class="co">#&gt; 6        bio_7  0.001577512 Model_192</span></span>
<span><span class="co">#&gt; 7   I(bio_1^2)  0.368476226 Model_219</span></span>
<span><span class="co">#&gt; 8        bio_1  0.332782286 Model_219</span></span>
<span><span class="co">#&gt; 9       bio_15  0.155708606 Model_219</span></span>
<span><span class="co">#&gt; 10 I(bio_15^2)  0.095186390 Model_219</span></span>
<span><span class="co">#&gt; 11 I(bio_12^2)  0.022722557 Model_219</span></span>
<span><span class="co">#&gt; 12      bio_12  0.021793617 Model_219</span></span>
<span><span class="co">#&gt; 13  I(bio_7^2)  0.003330318 Model_219</span></span>
<span></span>
<span><span class="co"># Plot variable contribution for model 192</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>cex <span class="op">=</span> <span class="fl">0.7</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">2.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Set grid of plot</span></span>
<span><span class="fu"><a href="../reference/plot_importance.html">plot_importance</a></span><span class="op">(</span><span class="va">imp_terms</span>, main <span class="op">=</span> <span class="st">"Importance of variable terms"</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_exploration_files/figure-html/term%20importance-1.png" class="r-plt" alt="" width="672"></p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="model-evaluation-with-independent-data">Model evaluation with independent data<a class="anchor" aria-label="anchor" href="#model-evaluation-with-independent-data"></a>
</h2>
<p>Selected models can be evaluated using an independent set of presence
records (not used when fitting selected models). This approach is
especially useful when new records become available. This can be useful
to assess models for invasive species, for which model fitting is
usually done in native areas with transfers to potential invasive
areas.</p>
<p>The <code><a href="../reference/independent_evaluation.html">independent_evaluation()</a></code> function computes omission
rates (i.e., the proportion of independent records predicted as below
the suitability threshold) and partial ROC. The function also assesses
whether environmental conditions in independent data are analogous those
under which models were fit using the mobility oriented-parity metric
(MOP; <a href="https://biogeography.pensoft.net/article/132916/" class="external-link">Cobos
et al. 2024</a>).</p>
<p>Let’s use the <code>new_occ</code> as an example of independent data
(provided in the package). This dataset contains coordinates of
<em>Myrcia hatschbachii</em> sourced from NeotropicTree (<a href="http://www.neotroptree.info/" class="external-link">Oliveira-Filho, 2017</a>), and they
were not part of the data used to fit the models.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import independent records</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"new_occ"</span>, package <span class="op">=</span> <span class="st">"kuenm2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># See data structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">new_occ</span><span class="op">)</span></span>
<span><span class="co">#&gt; Classes 'data.table' and 'data.frame':   82 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;  $ species: chr  "Myrcia hatschbachii" "Myrcia hatschbachii" "Myrcia hatschbachii" "Myrcia hatschbachii" ...</span></span>
<span><span class="co">#&gt;  $ x      : num  -48.3 -49.1 -49.9 -49.4 -49.9 ...</span></span>
<span><span class="co">#&gt;  $ y      : num  -25.2 -25 -24.5 -24.5 -24.8 ...</span></span>
<span><span class="co">#&gt;  - attr(*, ".internal.selfref")=&lt;externalptr&gt;</span></span></code></pre></div>
<p><br></p>
<p>In order to evaluate predictive ability of models and how analogous
conditions in independent data are to fitting conditions, environmental
values need to be extracted to these new records. Let’s import the
raster variables and extract values for <code>new_occ</code>:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import raster layers</span></span>
<span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Current_variables.tif"</span>,</span>
<span>                               package <span class="op">=</span> <span class="st">"kuenm2"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract variables to occurrences</span></span>
<span><span class="va">new_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_occurrence_variables.html">extract_occurrence_variables</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">new_occ</span>, x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                                         raster_variables <span class="op">=</span> <span class="va">var</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># See data structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">new_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    82 obs. of  8 variables:</span></span>
<span><span class="co">#&gt;  $ pr_bg   : num  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ x       : num  -48.3 -49.1 -49.9 -49.4 -49.9 ...</span></span>
<span><span class="co">#&gt;  $ y       : num  -25.2 -25 -24.5 -24.5 -24.8 ...</span></span>
<span><span class="co">#&gt;  $ bio_1   : num  20.2 18 16.6 17.8 16.7 ...</span></span>
<span><span class="co">#&gt;  $ bio_7   : num  16.7 18.2 19.9 19.4 20.1 ...</span></span>
<span><span class="co">#&gt;  $ bio_12  : num  2015 1456 1526 1414 1578 ...</span></span>
<span><span class="co">#&gt;  $ bio_15  : num  43.8 33.7 29.1 32.2 26.5 ...</span></span>
<span><span class="co">#&gt;  $ SoilType: num  6 6 6 6 6 10 10 10 10 10 ...</span></span></code></pre></div>
<p><br></p>
<p>Finding non-analogous conditions in independent records is not
uncommon, especially in regions outside model calibration areas. To
better illustrate this case, let’s add three fake records, in which some
variables have non-analogous values, either higher than the upper limit
or lower than the lower limit observed in the data used to fit
models.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add some fake data beyond the limits of calibration ranges</span></span>
<span><span class="va">fake_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"pr_bg"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                        <span class="st">"x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>                        <span class="st">"y"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>                        <span class="st">"bio_1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">23</span><span class="op">)</span>,</span>
<span>                        <span class="st">"bio_7"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fl">16</span>, <span class="fl">20</span><span class="op">)</span>,</span>
<span>                        <span class="st">"bio_12"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2300</span>, <span class="fl">2000</span>, <span class="fl">1000</span><span class="op">)</span>,</span>
<span>                        <span class="st">"bio_15"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>                        <span class="st">"SoilType"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bind data</span></span>
<span><span class="va">new_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">new_data</span>, <span class="va">fake_data</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
<p>Now, let’s evaluate models with this independent dataset (keep in
mind that the last three records are fake):</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Evaluate models with independent data</span></span>
<span><span class="va">res_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/independent_evaluation.html">independent_evaluation</a></span><span class="op">(</span>fitted_models <span class="op">=</span> <span class="va">fm</span>, new_data <span class="op">=</span> <span class="va">new_data</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
<p>The output is a list with three elements:</p>
<ol style="list-style-type: decimal">
<li>
<strong>evaluation</strong> metrics (omission rate and pROC) for
each selected model, as well as for the overall consensus.</li>
<li>
<strong>mop_results</strong>, a list containing the output of MOP
analysis comparing conditions in independent data and those used to fit
models. This happens because the <code>perform_mop</code> argument is
set to <code>TRUE</code> (the default).</li>
<li>
<strong>predictions</strong> of continuous and binary suitability
for each of the independent records (the default;
<code>return_predictions = TRUE</code>). In addition, MOP results are
included for all the records.</li>
</ol>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ind</span><span class="op">$</span><span class="va">evaluation</span></span>
<span><span class="co">#&gt;               Model consensus Omission_rate_at_10 Mean_AUC_ratio pval_pROC</span></span>
<span><span class="co">#&gt; 1         Model_192      mean           0.3647059       1.167024         0</span></span>
<span><span class="co">#&gt; 2         Model_192    median           0.3764706       1.175520         0</span></span>
<span><span class="co">#&gt; 3         Model_219      mean           0.3882353       1.144704         0</span></span>
<span><span class="co">#&gt; 4         Model_219    median           0.3764706       1.145789         0</span></span>
<span><span class="co">#&gt; 5 General_consensus    median           0.3882353       1.163761         0</span></span>
<span><span class="co">#&gt; 6 General_consensus      mean           0.3764706       1.157164         0</span></span></code></pre></div>
<p><br></p>
<p>All selected models have significant pROC values, but show higher
omission rates than expected based on the 10% omission threshold used
for calibration (~35% of the independent records are predicted as
unsuitable) .</p>
<p>For each records, the following MOP results are provided:</p>
<ul>
<li>
<strong>mop_distance</strong>: the environmental distance (i.e.,
dissimilarity) of the independent record to the nearest set of
conditions considered to fit the models.</li>
<li>
<strong>inside_range</strong>: whether the environmental conditions
at the location of the independent record fall within the model fitting
range.</li>
<li>
<strong>n_var_out</strong>: the number of variables for which the
independent record is outside the model fitting range.</li>
<li>
<strong>towards_low</strong>: the names of variables with values
lower than the minimum observed in the model fitting data.</li>
<li>
<strong>towards_high</strong>: the names of variables with values
higher than the maximum observed in the model fitting data.</li>
</ul>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Show the mop results for the last 5 independent records</span></span>
<span><span class="va">res_ind</span><span class="op">$</span><span class="va">predictions</span><span class="op">$</span><span class="va">continuous</span><span class="op">[</span><span class="fl">81</span><span class="op">:</span><span class="fl">85</span> , <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mop_distance"</span>, <span class="st">"inside_range"</span>, </span>
<span>                                         <span class="st">"n_var_out"</span>, <span class="st">"towards_low"</span>, </span>
<span>                                         <span class="st">"towards_high"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;    mop_distance inside_range n_var_out  towards_low towards_high</span></span>
<span><span class="co">#&gt; 81     7.753558         TRUE         0         &lt;NA&gt;         &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 82     6.622770         TRUE         0         &lt;NA&gt;         &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 83   157.782905        FALSE         3 bio_7, bio_1       bio_12</span></span>
<span><span class="co">#&gt; 84    21.045482         TRUE         0         &lt;NA&gt;         &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 85   183.905420        FALSE         2       bio_12        bio_1</span></span></code></pre></div>
<p><br></p>
<p>Note that two of the three fake records we added to
<code>new_data</code> have non-analogous environmental conditions. One
of them falls in a location where <em>bio_7</em> and <em>bio_1</em> have
values lower than the minimum observed in the model fitting data,
whereas <em>bio_12</em> has a value higher than the maximum. Another
record is in a location where <em>bio_12</em> is below the model fitting
range, and <em>bio_1</em> exceeds the upper limit.</p>
<p><br></p>
<p>When we set <code>return_predictions = TRUE</code> (the default), the
function also returns the predictions for each selected model and for
the general consensus:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Show the continuous predictions for the last 5 independent records</span></span>
<span><span class="co"># Round to two decimal places</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">res_ind</span><span class="op">$</span><span class="va">predictions</span><span class="op">$</span><span class="va">continuous</span><span class="op">[</span><span class="fl">81</span><span class="op">:</span><span class="fl">85</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Model_192.mean Model_192.median Model_219.mean Model_219.median</span></span>
<span><span class="co">#&gt; 81           0.49             0.48           0.52             0.51</span></span>
<span><span class="co">#&gt; 82           0.44             0.44           0.45             0.42</span></span>
<span><span class="co">#&gt; 83           0.00             0.00           0.00             0.00</span></span>
<span><span class="co">#&gt; 84           0.95             0.96           0.76             0.78</span></span>
<span><span class="co">#&gt; 85           0.00             0.00           0.00             0.00</span></span>
<span><span class="co">#&gt;    General_consensus.median General_consensus.mean</span></span>
<span><span class="co">#&gt; 81                     0.50                   0.50</span></span>
<span><span class="co">#&gt; 82                     0.44                   0.44</span></span>
<span><span class="co">#&gt; 83                     0.00                   0.00</span></span>
<span><span class="co">#&gt; 84                     0.94                   0.85</span></span>
<span><span class="co">#&gt; 85                     0.00                   0.00</span></span>
<span></span>
<span><span class="co"># Show the binary predictions for the last 5 independent records</span></span>
<span><span class="va">res_ind</span><span class="op">$</span><span class="va">predictions</span><span class="op">$</span><span class="va">binary</span><span class="op">[</span><span class="fl">81</span><span class="op">:</span><span class="fl">85</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span></span>
<span><span class="co">#&gt;    Model_192.mean Model_192.median Model_219.mean Model_219.median</span></span>
<span><span class="co">#&gt; 81              1                1              1                1</span></span>
<span><span class="co">#&gt; 82              1                1              1                1</span></span>
<span><span class="co">#&gt; 83              0                0              0                0</span></span>
<span><span class="co">#&gt; 84              1                1              1                1</span></span>
<span><span class="co">#&gt; 85              0                0              0                0</span></span>
<span><span class="co">#&gt;    General_consensus.mean General_consensus.median</span></span>
<span><span class="co">#&gt; 81                      1                        1</span></span>
<span><span class="co">#&gt; 82                      1                        1</span></span>
<span><span class="co">#&gt; 83                      0                        0</span></span>
<span><span class="co">#&gt; 84                      1                        1</span></span>
<span><span class="co">#&gt; 85                      0                        0</span></span></code></pre></div>
<p><br></p>
<p>These results can help determine whether independent data should be
incorporated into the calibration dataset to re-run models. If omission
rates for independent records are too high, pROC values are
non-significant, or most of the records show non-analogous environmental
conditions, it might be a good idea to re-run the models including
independent records.</p>
<p><br></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reset plotting parameters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">original_par</span><span class="op">)</span> </span></code></pre></div>
<p><br></p>
</div>
<div class="section level2">
<h2 id="saving-a-fitted_models-object">Saving a fitted_models object<a class="anchor" aria-label="anchor" href="#saving-a-fitted_models-object"></a>
</h2>
<p>After fitting the best-performing models with
<code><a href="../reference/fit_selected.html">fit_selected()</a></code>, we can proceed to predict the models for
single or multiple scenarios. As this object is essentially a list,
users can save it to a local directory using <code><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">saveRDS()</a></code>.
Saving the object facilitates loading it back into your R session later
using <code><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS()</a></code>. See an example below:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set directory to save (here, in a temporary directory)</span></span>
<span><span class="va">dir_to_save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save the data:</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">fm</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_to_save</span>, <span class="st">"fitted_models.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Import data</span></span>
<span><span class="va">fm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_to_save</span>, <span class="st">"fitted_models.rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Weverton C. F. Trindade, Luis F. Arias-Giraldo, Luis Osorio-Olvera, A. Townsend Peterson, Marlon E. Cobos.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
