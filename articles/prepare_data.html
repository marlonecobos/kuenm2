<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2. Prepare Data for Model Calibration • kuenm2</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2. Prepare Data for Model Calibration">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">kuenm2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.11</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-book"></span> Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/basic_data_cleaning.html">1. Basic Data Cleaning</a></li>
    <li><a class="dropdown-item" href="../articles/prepare_data.html">2. Prepare Data for Model Calibration</a></li>
    <li><a class="dropdown-item" href="../articles/model_calibration.html">3. Model Calibration</a></li>
    <li><a class="dropdown-item" href="../articles/model_exploration.html">4. Fit and Explore Selected Models</a></li>
    <li><a class="dropdown-item" href="../articles/model_predictions.html">5. Project Models to a Single Scenario</a></li>
    <li><a class="dropdown-item" href="../articles/model_projections.html">6. Project Models to Multiple Scenarios</a></li>
    <li><a class="dropdown-item" href="../articles/variability_and_uncertainty.html">7. Exploring Model Uncertainty and Variability</a></li>
    <li><a class="dropdown-item" href="../articles/projections_chelsa.html">8. Example of Projections Using CHELSA Data</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/marlonecobos/kuenm2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>2. Prepare Data for Model Calibration</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/marlonecobos/kuenm2/blob/main/vignettes/prepare_data.Rmd" class="external-link"><code>vignettes/prepare_data.Rmd</code></a></small>
      <div class="d-none name"><code>prepare_data.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#getting-ready">Getting ready</a></li>
<li>
<a href="#preparing-data">Preparing data</a>
<ul>
<li><a href="#example-data">Example data</a></li>
<li><a href="#first-steps-in-preparing-data">First steps in preparing
data</a></li>
<li><a href="#using-pre-processed-data">Using pre-processed
data</a></li>
</ul>
</li>
<li>
<a href="#exploring-prepared-data">Exploring prepared data</a>
<ul>
<li><a href="#comparative-histograms">Comparative histograms</a></li>
<li><a href="#distribution-of-data-for-models">Distribution of data for
models</a></li>
<li><a href="#similarity-assessment-in-partitions">Similarity assessment
in partitions</a></li>
</ul>
</li>
<li>
<a href="#more-options-to-prepare-data">More options to prepare
data</a>
<ul>
<li><a href="#custom-formulas">Custom formulas</a></li>
<li><a href="#using-a-bias-file">Using a bias file</a></li>
<li>
<a href="#pca-for-variables">PCA for variables</a>
<ul>
<li><a href="#internal-pca">Internal PCA</a></li>
<li><a href="#external-pca">External PCA</a></li>
</ul>
</li>
<li>
<a href="#using-external-data-partitions">Using external data
partitions</a>
<ul>
<li><a href="#enmeval-partitions">ENMeval partitions</a></li>
<li><a href="#flexsdm-partitions">flexsdm partitions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#saving-prepared-data">Saving prepared data</a></li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="description">Description<a class="anchor" aria-label="anchor" href="#description"></a>
</h2>
<p>Before starting the ENM process, data must be formatted in a specific
structure required by functions in <code>kuenm2</code>. This vignette
guides users through the steps necessary to prepare occurrence data and
environmental predictors using built-in tools. It covers the use of the
main functions, <code><a href="../reference/prepare_data.html">prepare_data()</a></code> and
<code><a href="../reference/prepare_user_data.html">prepare_user_data()</a></code>, to generate standardized objects that
are essential for model calibration. The guide also demonstrates options
to compute principal components from variables (PCA), incorporating
sampling bias, integrating data partitioning schemes from external
methods, exploring prepared data, and saving the data object for later
use.</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="getting-ready">Getting ready<a class="anchor" aria-label="anchor" href="#getting-ready"></a>
</h2>
<p>If <code>kuenm2</code> has not been installed yet, please do so. See
the <a href="../index.html">Main guide</a> for installation
instructions. See also the <a href="basic_data_cleaning.html">basic data
cleaning guide</a> for some data cleaning steps.</p>
<p>Use the following lines of code to load <code>kuenm2</code> and any
other required packages, and define a working directory (if needed). In
general, setting a working directory in R is considered good practice,
as it provides better control over where files are read from or saved
to. If users are not working within an R project, we recommend setting a
working directory, since at least one file will be saved at later stages
of this guide.</p>
<p>Note: functions from other packages (i.e., not from base R or
<code>kuenm2</code> ) used in this guide will be displayed as
<code>package::function()</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marlonecobos.github.io/kuenm2/">kuenm2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Current directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define new directory</span></span>
<span><span class="co">#setwd("YOUR/DIRECTORY")  # uncomment and modify if setting a new directory</span></span>
<span></span>
<span><span class="co"># Saving original plotting parameters</span></span>
<span><span class="va">original_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>no.readonly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
</div>
<div class="section level2">
<h2 id="preparing-data">Preparing data<a class="anchor" aria-label="anchor" href="#preparing-data"></a>
</h2>
<div class="section level3">
<h3 id="example-data">Example data<a class="anchor" aria-label="anchor" href="#example-data"></a>
</h3>
<p>We will use occurrence records provided within the
<code>kuenm2</code> package. Most example data in the package is derived
from <a href="https://doi.org/10.1111/ddi.13931" class="external-link">Trindade &amp; Marques
(2024)</a>. The <code>occ_data</code> object contains 51 occurrences of
<em>Myrcia hatschbachii</em>, a tree endemic to Southern Brazil.
Although this example data set has three columns (species, x, and y),
only two numeric columns with longitude and latitude coordinates are
required.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import occurrences</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">occ_data</span>, package <span class="op">=</span> <span class="st">"kuenm2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check data structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">occ_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    51 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;  $ species: chr  "Myrcia hatschbachii" "Myrcia hatschbachii" "Myrcia hatschbachii" "Myrcia hatschbachii" ...</span></span>
<span><span class="co">#&gt;  $ x      : num  -51.3 -50.6 -49.3 -49.8 -50.2 ...</span></span>
<span><span class="co">#&gt;  $ y      : num  -29 -27.6 -27.8 -26.9 -28.2 ...</span></span></code></pre></div>
<p><br></p>
<p>As predictor variables, we will use another dataset included in the
package. This dataset comprises four bioclimatic variables from <a href="https://worldclim.org/data/bioclim.html" class="external-link">WorldClim 2.1</a> at 10
arc-minute resolution, and a categorical variable (SoilType) from <a href="https://soilgrids.org/" class="external-link">SoilGrids</a> aggregated to 10
arc-minutes. All variables have been masked using a polygon that
delimits the area for model calibration. This polygon was generated by
drawing a minimum convex polygon around the records, with a 300 km
buffer.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import raster layers</span></span>
<span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Current_variables.tif"</span>, </span>
<span>                               package <span class="op">=</span> <span class="st">"kuenm2"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check variables</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/Load%20variables-1.png" class="r-plt" alt="" width="70%"></p>
<p><br></p>
<p>Visualize occurrences records in geography:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize occurrences on one variable</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var</span><span class="op">[[</span><span class="st">"bio_1"</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Bio 1"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">occ_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/unnamed-chunk-3-1.png" class="r-plt" alt="" width="70%"></p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="first-steps-in-preparing-data">First steps in preparing data<a class="anchor" aria-label="anchor" href="#first-steps-in-preparing-data"></a>
</h3>
<p>The functions <code><a href="../reference/prepare_data.html">prepare_data()</a></code> and
<code><a href="../reference/prepare_user_data.html">prepare_user_data()</a></code> are central to getting data ready for
model calibration. They handles several key steps:</p>
<ul>
<li>
<strong>Defining the algorithm</strong>: Users can choose between
<code>maxnet</code> or <code>glm</code>.</li>
<li>
<strong>Generating background points</strong>: Background points are
sampled from raster layers (<code><a href="../reference/prepare_data.html">prepare_data()</a></code>), unless
provided by the user (<code><a href="../reference/prepare_user_data.html">prepare_user_data()</a></code>). Background
points serve as a reference to contrast presence records.</li>
<li>
<strong>Principal component analysis (PCA)</strong>: An optional
step that can be done with the variables provided.</li>
<li>
<strong>Preparing calibration data</strong>: Presence records and
background points are associate with predictor values and put together
in a <code>data.frame</code> to be used in the ENM. Calibration data is
provided by the user in <code><a href="../reference/prepare_user_data.html">prepare_user_data()</a></code>.</li>
<li>
<strong>Data partitioning</strong>: The function divides your data
to prepare training and testing sets via a cross-validation process. The
partitioning methods directly available include <code>kfolds</code>,
<code>subsample</code>, and <code>bootstrap</code>.</li>
<li>
<strong>Defining grid of model parameters</strong>: This helps
setting up combinations of feature classes (FCs), regularization
multiplier (RM) values (for Maxnet), and sets of predictor variables. An
explanation of the roles of RMs and FCs in Maxent models see <a href="https://doi.org/10.1111/j.1600-0587.2013.07872.x" class="external-link">Merow et
al. 2013</a>.</li>
</ul>
<p>As with any function, we recommend checking the documentation with
<code><a href="../reference/prepare_data.html">help(prepare_data)</a></code> for more detailed explanations. Now,
let’s prepare the data for model calibration, using 4 k-folds to
partition training and testing datasets:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data for maxnet model</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                  occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                  x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                  raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                  species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                  categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>, </span>
<span>                  partition_method <span class="op">=</span> <span class="st">"kfolds"</span>, </span>
<span>                  n_partitions <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                  n_background <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                  features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                  r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 43 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span></code></pre></div>
<p><br></p>
<p>The <code><a href="../reference/prepare_data.html">prepare_data()</a></code> function returns a
<code>prepared_data</code> object, a list that contains several
essential components for model calibration. Below is an example of the
object’s printed output, which provides a summary of its contents.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt; prepared_data object summary</span></span>
<span><span class="co">#&gt; ============================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of Records: 1008 </span></span>
<span><span class="co">#&gt;   - Presence: 51 </span></span>
<span><span class="co">#&gt;   - Background: 957 </span></span>
<span><span class="co">#&gt; Partition Method: kfolds </span></span>
<span><span class="co">#&gt;   - Number of kfolds: 4 </span></span>
<span><span class="co">#&gt; Continuous Variables:</span></span>
<span><span class="co">#&gt;   - bio_1, bio_7, bio_12, bio_15 </span></span>
<span><span class="co">#&gt; Categorical Variables:</span></span>
<span><span class="co">#&gt;   - SoilType </span></span>
<span><span class="co">#&gt; PCA Information: PCA not performed</span></span>
<span><span class="co">#&gt; Weights: No weights provided</span></span>
<span><span class="co">#&gt; Calibration Parameters:</span></span>
<span><span class="co">#&gt;   - Algorithm: maxnet </span></span>
<span><span class="co">#&gt;   - Number of candidate models: 300 </span></span>
<span><span class="co">#&gt;   - Features classes (responses): l, q, lq, lqp </span></span>
<span><span class="co">#&gt;   - Regularization multipliers: 0.1, 2, 1</span></span></code></pre></div>
<p><br></p>
<p>The parts of the <code>prepared_data</code> object can be explored in
further detail by indexing them as in the following example.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check the algorithm selected</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">algorithm</span></span>
<span><span class="co">#&gt; [1] "maxnet"</span></span>
<span></span>
<span><span class="co"># See first rows of calibration data</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">calibration_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   pr_bg    bio_1    bio_7 bio_12   bio_15 SoilType</span></span>
<span><span class="co">#&gt; 1     1 16.49046 18.66075   1778 12.96107       19</span></span>
<span><span class="co">#&gt; 2     1 15.46644 19.65775   1560 14.14697       19</span></span>
<span><span class="co">#&gt; 3     1 15.70560 17.99450   1652 23.27548        6</span></span>
<span><span class="co">#&gt; 4     1 17.78899 19.55600   1597 18.91694        1</span></span>
<span><span class="co">#&gt; 5     1 15.50116 18.30750   1497 15.39440       19</span></span>
<span><span class="co">#&gt; 6     1 17.42421 17.25875   1760 34.17664        6</span></span>
<span></span>
<span><span class="co"># See first rows of formula grid</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">formula_grid</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ID           Formulas R_multiplier Features</span></span>
<span><span class="co">#&gt; 1  1  ~bio_1 + bio_7 -1          0.1        l</span></span>
<span><span class="co">#&gt; 2  2  ~bio_1 + bio_7 -1          2.0        l</span></span>
<span><span class="co">#&gt; 3  3  ~bio_1 + bio_7 -1          1.0        l</span></span>
<span><span class="co">#&gt; 4  4 ~bio_1 + bio_12 -1          2.0        l</span></span>
<span><span class="co">#&gt; 5  5 ~bio_1 + bio_12 -1          1.0        l</span></span>
<span><span class="co">#&gt; 6  6 ~bio_1 + bio_12 -1          0.1        l</span></span></code></pre></div>
<p><br></p>
<p>The algorithms that can be selected are <code>"maxnet"</code> or
<code>"glm"</code>. When using GLMs, regularization multipliers are not
used.</p>
<p>Now, let’s run an example using <code>glm</code>, this time using the
<code>subsample</code> partitioning method, with a total of 10
partitions, and 70% of the dataset used for training in every
iteration.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data selecting GLM as the algorithm</span></span>
<span><span class="va">d_glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"glm"</span>,</span>
<span>                      occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                      x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                      raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                      species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                      categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>, </span>
<span>                      partition_method <span class="op">=</span> <span class="st">"subsample"</span>, </span>
<span>                      n_partitions <span class="op">=</span> <span class="fl">10</span>, </span>
<span>                      train_proportion <span class="op">=</span> <span class="fl">0.7</span>,</span>
<span>                      n_background <span class="op">=</span> <span class="fl">300</span>,</span>
<span>                      features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                      r_multiplier <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>  <span class="co"># Not necessary with GLMs</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 8 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span>
<span></span>
<span><span class="co"># Print object</span></span>
<span><span class="va">d_glm</span></span>
<span><span class="co">#&gt; prepared_data object summary</span></span>
<span><span class="co">#&gt; ============================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of Records: 343 </span></span>
<span><span class="co">#&gt;   - Presence: 51 </span></span>
<span><span class="co">#&gt;   - Background: 292 </span></span>
<span><span class="co">#&gt; Partition Method: subsample </span></span>
<span><span class="co">#&gt;   - Number of replicates: </span></span>
<span><span class="co">#&gt;   - Train proportion: 0.7 </span></span>
<span><span class="co">#&gt; Continuous Variables:</span></span>
<span><span class="co">#&gt;   - bio_1, bio_7, bio_12, bio_15 </span></span>
<span><span class="co">#&gt; Categorical Variables:</span></span>
<span><span class="co">#&gt;   - SoilType </span></span>
<span><span class="co">#&gt; PCA Information: PCA not performed</span></span>
<span><span class="co">#&gt; Weights: No weights provided</span></span>
<span><span class="co">#&gt; Calibration Parameters:</span></span>
<span><span class="co">#&gt;   - Algorithm: glm </span></span>
<span><span class="co">#&gt;   - Number of candidate models: 122 </span></span>
<span><span class="co">#&gt;   - Features classes (responses): l, q, p, lq, lqp</span></span></code></pre></div>
<p><br></p>
</div>
<div class="section level3">
<h3 id="using-pre-processed-data">Using pre-processed data<a class="anchor" aria-label="anchor" href="#using-pre-processed-data"></a>
</h3>
<p>In some cases, users already have data that has been prepared for
model calibration (e.g., when data is prepared for time-specific
applications). When that is the case, the function
<code><a href="../reference/prepare_user_data.html">prepare_user_data()</a></code> can take the pre-processed data and get
them ready for the next analyses. User-prepared data must be a
<code>data.frame</code> that includes a column with zeros and ones,
indicating <strong>presence (1)</strong> and <strong>background
(0)</strong> records, along with columns with values for each of the
<strong>variables</strong>. The package includes an example of such a
<code>data.frame</code> for reference (see below).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"user_data"</span>, package <span class="op">=</span> <span class="st">"kuenm2"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">user_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   pr_bg    bio_1    bio_7 bio_12   bio_15 SoilType</span></span>
<span><span class="co">#&gt; 1     1 16.49046 18.66075   1778 12.96107       19</span></span>
<span><span class="co">#&gt; 2     1 15.46644 19.65775   1560 14.14697       19</span></span>
<span><span class="co">#&gt; 3     1 15.70560 17.99450   1652 23.27548        6</span></span>
<span><span class="co">#&gt; 4     1 17.78899 19.55600   1597 18.91694        1</span></span>
<span><span class="co">#&gt; 5     1 15.50116 18.30750   1497 15.39440       19</span></span>
<span><span class="co">#&gt; 7     1 17.42421 17.25875   1760 34.17664        6</span></span></code></pre></div>
<p><br></p>
<p>The <code><a href="../reference/prepare_user_data.html">prepare_user_data()</a></code> function operates similarly to
<code><a href="../reference/prepare_data.html">prepare_data()</a></code>, but with key differences. The main
difference is that instead of requiring a table with coordinates and a
<code>SpatRaster</code> of variables, it takes the already prepared
<code>data.frame</code>. See full documentation with
<code><a href="../reference/prepare_user_data.html">help(prepare_user_data)</a></code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data for maxnet model</span></span>
<span><span class="va">data_user</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_user_data.html">prepare_user_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                               user_data <span class="op">=</span> <span class="va">user_data</span>,  <span class="co"># user-prepared data.frame</span></span>
<span>                               pr_bg <span class="op">=</span> <span class="st">"pr_bg"</span>,</span>
<span>                               species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                               categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                               partition_method <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>                               features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                               r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_user</span> </span>
<span><span class="co">#&gt; prepared_data object summary</span></span>
<span><span class="co">#&gt; ============================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of Records: 527 </span></span>
<span><span class="co">#&gt;   - Presence: 51 </span></span>
<span><span class="co">#&gt;   - Background: 476 </span></span>
<span><span class="co">#&gt; Partition Method: bootstrap </span></span>
<span><span class="co">#&gt;   - Number of replicates: </span></span>
<span><span class="co">#&gt;   - Train proportion: 0.7 </span></span>
<span><span class="co">#&gt; Continuous Variables:</span></span>
<span><span class="co">#&gt;   - bio_1, bio_7, bio_12, bio_15 </span></span>
<span><span class="co">#&gt; Categorical Variables:</span></span>
<span><span class="co">#&gt;   - SoilType </span></span>
<span><span class="co">#&gt; PCA Information: PCA not performed</span></span>
<span><span class="co">#&gt; Weights: No weights provided</span></span>
<span><span class="co">#&gt; Calibration Parameters:</span></span>
<span><span class="co">#&gt;   - Algorithm: maxnet </span></span>
<span><span class="co">#&gt;   - Number of candidate models: 610 </span></span>
<span><span class="co">#&gt;   - Features classes (responses): l, q, p, lq, lqp </span></span>
<span><span class="co">#&gt;   - Regularization multipliers: 0.1, 1, 2, 3, 5</span></span></code></pre></div>
<p><br></p>
<p>This function also allows users to provide a list identifying which
points should be used for testing in each cross-validation iteration.
This can be useful to keep data partitions stable among distinct model
calibration routines. If <code>user_folds</code> is <code>NULL</code>
(the default), the function partitions the data according to
<code>partition_method</code>, <code>n_partitions</code>, and
<code>train_proportion</code>.</p>
<p><br></p>
</div>
</div>
<div class="section level2">
<h2 id="exploring-prepared-data">Exploring prepared data<a class="anchor" aria-label="anchor" href="#exploring-prepared-data"></a>
</h2>
<p>In the following examples, we’ll use the object <code>d</code>,
prepared using the <code>maxnet</code> algorithm. The same can be done
with <code>prepared_data</code> using <code>glm</code> as de
algorithm.</p>
<p><br></p>
<div class="section level3">
<h3 id="comparative-histograms">Comparative histograms<a class="anchor" aria-label="anchor" href="#comparative-histograms"></a>
</h3>
<p>Users can visualize the distribution of predictor values for
occurrence records, background points, and the entire calibration area
using histograms. An example is presented below. See full documentation
with <code><a href="../reference/explore_calibration_hist.html">help(explore_calibration_hist)</a></code> and
<code>help(plot_explore_calibration)</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare histogram data</span></span>
<span><span class="va">calib_hist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_calibration_hist.html">explore_calibration_hist</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d</span>, raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                                       include_m <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot histograms</span></span>
<span><span class="fu"><a href="../reference/plot_calibration_hist.html">plot_calibration_hist</a></span><span class="op">(</span>explore_calibration <span class="op">=</span> <span class="va">calib_hist</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/explore%20histogram-1.png" class="r-plt" alt="" width="70%"></p>
<p><br></p>
<p>In the previous plot, gray represents values across the entire
calibration area, blue background values, and green values at presence
records (magnified by a factor of 2 to enhance visualization). Both the
colors and the magnification factor can be customized.</p>
<p>If <code>raster_variables</code> are not available, exclude that
argument and <code>include_m</code> when running the function
<code><a href="../reference/explore_calibration_hist.html">explore_calibration_hist()</a></code>. This could happen when users
have pre-processed data and run <code><a href="../reference/prepare_user_data.html">prepare_user_data()</a></code>.</p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="distribution-of-data-for-models">Distribution of data for models<a class="anchor" aria-label="anchor" href="#distribution-of-data-for-models"></a>
</h3>
<p>Additionally, users can explore the geographic distribution of
occurrences and background, as well as how they were partitioned. See
full documentation with <code><a href="../reference/explore_partition_geo.html">help(explore_partition_geo)</a></code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Explore spatial distribution</span></span>
<span><span class="va">pbg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_partition_geo.html">explore_partition_geo</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d</span>, raster_variables <span class="op">=</span> <span class="va">var</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot exploration results in geography</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pbg</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/explore%20spatial-1.png" class="r-plt" alt="" width="75%"></p>
<p><br></p>
<p>Note that, by default, background points are selected randomly within
the calibration area. However, users can influence this selection by
providing a bias file (see section <a href="#more-options-to-prepare-data">More options to prepare
data</a>).</p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="similarity-assessment-in-partitions">Similarity assessment in partitions<a class="anchor" aria-label="anchor" href="#similarity-assessment-in-partitions"></a>
</h3>
<p>When partitioning data, some testing points may fall into
environments that are different from those in which training points are.
This forces the model to evaluate under extrapolation, testing its
predictions on conditions outside its training range.</p>
<p>The <code><a href="../reference/explore_partition_extrapolation.html">explore_partition_extrapolation()</a></code> function
calculates dissimilarity and detects non-analogous conditions in testing
points after comparing them to the training data for each partition.
Dissimilarity tests are performed using the mobility-oriented parity
metric (MOP; <a href="https://doi.org/10.1016/j.ecolmodel.2013.04.011" class="external-link">Owens et
al. 2013</a>) as in <a href="https://biogeography.pensoft.net/article/132916/" class="external-link">Cobos et
al. (2024)</a>. This analysis only requires a <code>prepared_data</code>
object.</p>
<p>By default, the function
<code><a href="../reference/explore_partition_extrapolation.html">explore_partition_extrapolation()</a></code> uses all training data
(presences and backgrounds) to define the environmental space of
reference, and computes MOP for testing records. If computing MOP for
test background points is needed, set
<code>include_test_background = TRUE</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run extrapolation risk analysis</span></span>
<span><span class="va">mop_partition</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_partition_extrapolation.html">explore_partition_extrapolation</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d</span>, </span>
<span>                                                 include_test_background <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
<p>The previous run returns a list in which the main outcome is
<code>Mop_results</code>. This is a <code>data.frame</code>, in which
each row is a testing record; the columns are:</p>
<ul>
<li>
<strong>mop_distance</strong>: MOP distances;</li>
<li>
<strong>inside_range</strong> an indicator of whether environmental
conditions at each testing record fall within the training range;</li>
<li>
<strong>n_var_out</strong>: number of variables outside the training
range;</li>
<li>
<strong>towards_low</strong> and <strong>towards_high </strong>:
names of variables with values lower or higher than the training
range;</li>
<li>
<strong>SoilType</strong>: because the <code>prepared_data</code>
object includes a categorical variable, it also contains a column
indicating which categories in testing data were not present in training
data.</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check some of the results</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mop_partition</span><span class="op">$</span><span class="va">Mop_results</span><span class="op">)</span></span>
<span><span class="co">#&gt;      Partition pr_bg         x         y mop_distance inside_range n_var_out</span></span>
<span><span class="co">#&gt; 1  Partition_1     1 -51.29778 -29.02639     3.813469         TRUE         0</span></span>
<span><span class="co">#&gt; 3  Partition_1     1 -49.32222 -27.81167     3.671747         TRUE         0</span></span>
<span><span class="co">#&gt; 17 Partition_1     1 -51.03556 -28.58194     5.315553         TRUE         0</span></span>
<span><span class="co">#&gt; 18 Partition_1     1 -50.57972 -27.29056     3.240024         TRUE         0</span></span>
<span><span class="co">#&gt; 19 Partition_1     1 -49.82139 -27.40639     4.342539         TRUE         0</span></span>
<span><span class="co">#&gt; 26 Partition_1     1 -49.27361 -25.38528     4.623356         TRUE         0</span></span>
<span><span class="co">#&gt;    towards_low towards_high SoilType</span></span>
<span><span class="co">#&gt; 1         &lt;NA&gt;         &lt;NA&gt;     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3         &lt;NA&gt;         &lt;NA&gt;     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 17        &lt;NA&gt;         &lt;NA&gt;     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 18        &lt;NA&gt;         &lt;NA&gt;     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 19        &lt;NA&gt;         &lt;NA&gt;     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 26        &lt;NA&gt;         &lt;NA&gt;     &lt;NA&gt;</span></span>
<span></span>
<span><span class="co"># Number of testing records with values outside training ranges</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mop_partition</span><span class="op">$</span><span class="va">Mop_results</span><span class="op">[</span><span class="va">mop_partition</span><span class="op">$</span><span class="va">Mop_results</span><span class="op">$</span><span class="va">n_var_out</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p><br></p>
<p>Now we can use the function <code><a href="../reference/plot_explore_partition.html">plot_explore_partition()</a></code> to
visualize the records from each partition in both geographic and
environmental spaces. As comparisons were performed in environmental
space, to visualize results in geographic space the plotting functions
uses a simplified map of the world, but another spatial object can be
defined in <code>calibration_area</code> if needed.</p>
<p>The type MOP result to plot can be specified as: “simple” to show
records in a partition within or out of envrionmental range of the other
partitions; or “distance” to display the distance of each record to the
nearest set of conditions in the other partitions.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simple plot in geographic space</span></span>
<span><span class="fu"><a href="../reference/plot_explore_partition.html">plot_explore_partition</a></span><span class="op">(</span>explore_partition <span class="op">=</span> <span class="va">mop_partition</span>, space <span class="op">=</span> <span class="st">"G"</span>, </span>
<span>                       type_of_plot <span class="op">=</span> <span class="st">"simple"</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/unnamed-chunk-5-1.png" class="r-plt" alt="" width="75%"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Distance plot in geographic space</span></span>
<span><span class="fu"><a href="../reference/plot_explore_partition.html">plot_explore_partition</a></span><span class="op">(</span>explore_partition <span class="op">=</span> <span class="va">mop_partition</span>, space <span class="op">=</span> <span class="st">"G"</span>, </span>
<span>                       type_of_plot <span class="op">=</span> <span class="st">"distance"</span>,</span>
<span>                       lwd_legend <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/unnamed-chunk-5-2.png" class="r-plt" alt="" width="75%"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Simple plot in environmental space</span></span>
<span><span class="fu"><a href="../reference/plot_explore_partition.html">plot_explore_partition</a></span><span class="op">(</span>explore_partition <span class="op">=</span> <span class="va">mop_partition</span>, space <span class="op">=</span> <span class="st">"E"</span>, </span>
<span>                       type_of_plot <span class="op">=</span> <span class="st">"simple"</span>, </span>
<span>                       variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bio_7"</span>, <span class="st">"bio_15"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/unnamed-chunk-5-3.png" class="r-plt" alt="" width="75%"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Distance plot in environmental space</span></span>
<span><span class="fu"><a href="../reference/plot_explore_partition.html">plot_explore_partition</a></span><span class="op">(</span>explore_partition <span class="op">=</span> <span class="va">mop_partition</span>, space <span class="op">=</span> <span class="st">"E"</span>, </span>
<span>                       type_of_plot <span class="op">=</span> <span class="st">"distance"</span>,</span>
<span>                       variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bio_7"</span>, <span class="st">"bio_15"</span><span class="op">)</span>, </span>
<span>                       lwd_legend <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/unnamed-chunk-5-4.png" class="r-plt" alt="" width="75%"></p>
<p><br></p>
<p>The data used in this example was partitioned using k-folds which
reduces the chances of finding novel conditions when comparing testing
vs training sets of data. However, that might not be the case when using
data partitioning methods such as spatial blocks (see <a href="#using-external-data-partitions">Using external data
partitions</a>).</p>
<p><br></p>
</div>
</div>
<div class="section level2">
<h2 id="more-options-to-prepare-data">More options to prepare data<a class="anchor" aria-label="anchor" href="#more-options-to-prepare-data"></a>
</h2>
<p>The examples of data preparation above show a few of the options that
can be used to get data ready to start the ENM process. The next
sections demonstrate other options available for data preparation,
including: (1) customizing the list of model formulas to test in model
calibration; (2) principal component analysis for variables; and (3)
using external data partitioning methods.</p>
<p><br></p>
<div class="section level3">
<h3 id="custom-formulas">Custom formulas<a class="anchor" aria-label="anchor" href="#custom-formulas"></a>
</h3>
<p>By default, <code>kuenm2</code> builds the formula grid automatically
using the variables provided and the feature classes defined.</p>
<p>For instance, if <code>raster_variables</code> or
<code>user_data</code> contain <em>bio_1</em> and <em>bio_12</em>, and
you set the features to <code>lq</code> (linear + quadratic), the
formula will include linear and quadratic terms for each variable. In
this example, the resulting formula would be:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="st">"~ bio_1 + bio_12 + I(bio_1^2) + I(bio_12^2)"</span></span>
<span><span class="co">#&gt; [1] "~ bio_1 + bio_12 + I(bio_1^2) + I(bio_12^2)"</span></span></code></pre></div>
<p><br></p>
<p>Instead of letting the functions build formulas based on selected
features, users can provide custom formulas. This is useful when full
control over which terms are included is needed (for example, including
the quadratic version of specific variables):</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set custom formulas</span></span>
<span><span class="va">my_formulas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"~ bio_1 + bio_12 + I(bio_1^2) + I(bio_12^2)"</span>,</span>
<span>                 <span class="st">"~ bio_1 + bio_12 + I(bio_1^2)"</span>,</span>
<span>                 <span class="st">"~ bio_1 + bio_12 + I(bio_12^2)"</span>,</span>
<span>                 <span class="st">"~ bio_1 + I(bio_1^2) + I(bio_12^2)"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prepare data using custom formulas</span></span>
<span><span class="va">d_custom_formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                                 occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                                 x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                                 raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                                 species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                                 categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                                 partition_method <span class="op">=</span> <span class="st">"kfolds"</span>,</span>
<span>                                 n_partitions <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                                 n_background <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                                 user_formulas <span class="op">=</span> <span class="va">my_formulas</span>,  <span class="co"># Custom formulas</span></span>
<span>                                 r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 43 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span>
<span></span>
<span><span class="co"># Check formula grid</span></span>
<span><span class="va">d_custom_formula</span><span class="op">$</span><span class="va">formula_grid</span></span>
<span><span class="co">#&gt;    ID                                       Formulas R_multiplier Features</span></span>
<span><span class="co">#&gt; 1   1 ~ bio_1 + bio_12 + I(bio_1^2) + I(bio_12^2) -1          0.1   User_q</span></span>
<span><span class="co">#&gt; 2   2               ~ bio_1 + bio_12 + I(bio_1^2) -1          0.1   User_q</span></span>
<span><span class="co">#&gt; 3   3              ~ bio_1 + bio_12 + I(bio_12^2) -1          0.1   User_q</span></span>
<span><span class="co">#&gt; 4   4          ~ bio_1 + I(bio_1^2) + I(bio_12^2) -1          0.1   User_q</span></span>
<span><span class="co">#&gt; 5   5 ~ bio_1 + bio_12 + I(bio_1^2) + I(bio_12^2) -1          1.0   User_q</span></span>
<span><span class="co">#&gt; 6   6               ~ bio_1 + bio_12 + I(bio_1^2) -1          1.0   User_q</span></span>
<span><span class="co">#&gt; 7   7              ~ bio_1 + bio_12 + I(bio_12^2) -1          1.0   User_q</span></span>
<span><span class="co">#&gt; 8   8          ~ bio_1 + I(bio_1^2) + I(bio_12^2) -1          1.0   User_q</span></span>
<span><span class="co">#&gt; 9   9 ~ bio_1 + bio_12 + I(bio_1^2) + I(bio_12^2) -1          2.0   User_q</span></span>
<span><span class="co">#&gt; 10 10               ~ bio_1 + bio_12 + I(bio_1^2) -1          2.0   User_q</span></span>
<span><span class="co">#&gt; 11 11              ~ bio_1 + bio_12 + I(bio_12^2) -1          2.0   User_q</span></span>
<span><span class="co">#&gt; 12 12          ~ bio_1 + I(bio_1^2) + I(bio_12^2) -1          2.0   User_q</span></span></code></pre></div>
<p><br></p>
</div>
<div class="section level3">
<h3 id="using-a-bias-file">Using a bias file<a class="anchor" aria-label="anchor" href="#using-a-bias-file"></a>
</h3>
<p>A bias file is a <code>SpatRaster</code> object that contains values
that influence the selection of background points within the calibration
area. This can be particularly useful for mitigating sampling bias. For
instance, if we want the selection of background points to be informed
by how historical sampling has been, a layer of the density of records
from a target group can be used (see <a href="https://doi.org/10.1046/j.1523-1739.2001.015003648.x" class="external-link">Ponder et
al. 2001</a>, <a href="https://doi.org/10.1046/j.1365-2699.2003.00867.x" class="external-link">Anderson et
al. 2003</a>, and <a href="https://doi.org/10.1111/ddi.13442" class="external-link">Barber et
al. 2020</a>). The bias file must have the same extent, resolution, and
number of cells as your raster variables.</p>
<p>Let’s illustrate this process with an example bias file included in
the package. This <code>SpatRaster</code> has lower values in the center
and higher values towards the borders of the area:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import a bias file</span></span>
<span><span class="va">bias</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"bias_file.tif"</span>, package <span class="op">=</span> <span class="st">"kuenm2"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check the bias values</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bias</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/import%20bias%20file-1.png" class="r-plt" alt="" width="70%"></p>
<p><br></p>
<p>This bias layer will be used to prepare two new datasets: one with a
“direct” bias effect (with higher probability of selecting background
points in regions with higher bias values) and another with an “inverse”
effect (the oposite).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Using a direct bias effect in sampling</span></span>
<span><span class="va">d_bias_direct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                              occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                              x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                              raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                              species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                              categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                              n_background <span class="op">=</span> <span class="fl">1000</span>, </span>
<span>                              partition_method <span class="op">=</span> <span class="st">"kfolds"</span>,</span>
<span>                              bias_file <span class="op">=</span> <span class="va">bias</span>, bias_effect <span class="op">=</span> <span class="st">"direct"</span>,  <span class="co"># bias parameters</span></span>
<span>                              features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                              r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 57 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span>
<span></span>
<span><span class="co"># Using an indirect bias effect </span></span>
<span><span class="va">d_bias_inverse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                               occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                               x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                               raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                               species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                               categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                               n_background <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                               partition_method <span class="op">=</span> <span class="st">"kfolds"</span>,</span>
<span>                               bias_file <span class="op">=</span> <span class="va">bias</span>, bias_effect <span class="op">=</span> <span class="st">"inverse"</span>,  <span class="co"># bias parameters</span></span>
<span>                               features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                               r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 45 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span></code></pre></div>
<p><br></p>
<p>Let’s use the <code>explore_partition_geo</code> function to see the
effect of using a bias file.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Explore spatial distribution of points</span></span>
<span><span class="co">## No bias</span></span>
<span><span class="va">geo_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_partition_geo.html">explore_partition_geo</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d</span>, raster_variables <span class="op">=</span> <span class="va">var</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Direct bias effect</span></span>
<span><span class="va">geo_dist_bias</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_partition_geo.html">explore_partition_geo</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d_bias_direct</span>,</span>
<span>                                       raster_variables <span class="op">=</span> <span class="va">var</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Inverse bias effect</span></span>
<span><span class="va">geo_dist_bias_inv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_partition_geo.html">explore_partition_geo</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d_bias_inverse</span>,</span>
<span>                                           raster_variables <span class="op">=</span> <span class="va">var</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Adjusting plotting grid</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>  </span>
<span></span>
<span><span class="co">## The plots to show sampling bias effects</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bias</span>, main <span class="op">=</span> <span class="st">"Bias file"</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">geo_dist</span><span class="op">$</span><span class="va">Background</span>, main <span class="op">=</span> <span class="st">"Random Background"</span>, </span>
<span>            plg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cex <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Decrease size of legend text)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">geo_dist_bias</span><span class="op">$</span><span class="va">Background</span>, main <span class="op">=</span> <span class="st">"Direct Bias Effect"</span>, </span>
<span>            plg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cex <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Decrease size of legend text)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">geo_dist_bias_inv</span><span class="op">$</span><span class="va">Background</span>, main <span class="op">=</span> <span class="st">"Inverse Bias Effect"</span>, </span>
<span>            plg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cex <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Decrease size of legend text)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/exp_part_geobias-1.png" class="r-plt" alt="" width="95%"></p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="pca-for-variables">PCA for variables<a class="anchor" aria-label="anchor" href="#pca-for-variables"></a>
</h3>
<p>A common approach in ENM involves summarizing the information from a
set of variables into a smaller set of orthogonal variables using
Principal Component Analysis (PCA) (see <a href="https://doi.org/10.7550/rmb.36723" class="external-link">Cruz-Cardenaz et al. 2014</a>
for an example). <code>kuenm2</code> has options to perform a PCA
internally or use variables that have been externally prepared as
PCs.</p>
<p><br></p>
<div class="section level4">
<h4 id="internal-pca">Internal PCA<a class="anchor" aria-label="anchor" href="#internal-pca"></a>
</h4>
<p><code>kuenm2</code> can perform all PCA transformations internally,
which eliminates the need of transforming raw variables into PCs when
producing projections later on. This is particularly advantageous when
projecting model results across multiple scenarios (e.g., various Global
Climate Models for different future periods). By performing PCA
internally, you only need to provide the raw environmental variables
(e.g., <code>bio_1</code>, <code>bio_2</code>, etc.) when making
projections; helper functions will handle the PCA transformation
internally.</p>
<p>Let’s explore how to implement this:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data for maxnet models using PCA parameters</span></span>
<span><span class="va">d_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                      occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                      x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                      raster_variables <span class="op">=</span> <span class="va">var</span>, </span>
<span>                      do_pca <span class="op">=</span> <span class="cn">TRUE</span>, center <span class="op">=</span> <span class="cn">TRUE</span>, scale <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># PCA parameters</span></span>
<span>                      species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                      categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                      n_background <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                      partition_method <span class="op">=</span> <span class="st">"kfolds"</span>,</span>
<span>                      features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                      r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 43 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span>
<span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">d_pca</span><span class="op">)</span></span>
<span><span class="co">#&gt; prepared_data object summary</span></span>
<span><span class="co">#&gt; ============================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of Records: 1008 </span></span>
<span><span class="co">#&gt;   - Presence: 51 </span></span>
<span><span class="co">#&gt;   - Background: 957 </span></span>
<span><span class="co">#&gt; Partition Method: kfolds </span></span>
<span><span class="co">#&gt;   - Number of kfolds: 4 </span></span>
<span><span class="co">#&gt; Continuous Variables:</span></span>
<span><span class="co">#&gt;   - bio_1, bio_7, bio_12, bio_15 </span></span>
<span><span class="co">#&gt; Categorical Variables:</span></span>
<span><span class="co">#&gt;   - SoilType </span></span>
<span><span class="co">#&gt; PCA Information:</span></span>
<span><span class="co">#&gt;   - Variables included: bio_1, bio_7, bio_12, bio_15 </span></span>
<span><span class="co">#&gt;   - Number of PCA components: 4 </span></span>
<span><span class="co">#&gt; Weights: No weights provided</span></span>
<span><span class="co">#&gt; Calibration Parameters:</span></span>
<span><span class="co">#&gt;   - Algorithm: maxnet </span></span>
<span><span class="co">#&gt;   - Number of candidate models: 610 </span></span>
<span><span class="co">#&gt;   - Features classes (responses): l, q, p, lq, lqp </span></span>
<span><span class="co">#&gt;   - Regularization multipliers: 0.1, 1, 2, 3, 5</span></span></code></pre></div>
<p><br></p>
<p>The elements <code>calibration_data</code> and
<code>formula_grid</code> have now been generated considering the
principal components (PCs). By default, all continuous variables were
included in the PCA, while categorical variables (e.g., “SoilType”) were
excluded. The default settings to define the number of PCs to retain
keeps as many PCs as needed to collectively explain 95% of the total
variance, and then further filter these, keeping only those axes that
individually explain at least 5% of the variance. These parameters can
be changed using the arguments in the function
<code><a href="../reference/prepare_data.html">prepare_data()</a></code>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check calibration data</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d_pca</span><span class="op">$</span><span class="va">calibration_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   pr_bg         PC1        PC2        PC3         PC4 SoilType</span></span>
<span><span class="co">#&gt; 1     1  1.48690341 1.01252697  0.1180156 -0.09119257       19</span></span>
<span><span class="co">#&gt; 2     1  1.46028074 0.17701144  1.1573461 -0.12326796       19</span></span>
<span><span class="co">#&gt; 3     1  0.82676494 1.21965795  0.8145129 -0.67588891        6</span></span>
<span><span class="co">#&gt; 4     1  0.62680441 0.03967459  0.1525997  0.18784282        1</span></span>
<span><span class="co">#&gt; 5     1  0.94584897 0.93302089  1.4382424 -0.03192094       19</span></span>
<span><span class="co">#&gt; 6     1 -0.07597437 1.55268331 -0.2007953 -0.98153204        6</span></span>
<span></span>
<span><span class="co"># Check formula grid</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d_pca</span><span class="op">$</span><span class="va">formula_grid</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ID      Formulas R_multiplier Features</span></span>
<span><span class="co">#&gt; 1  1 ~PC1 + PC2 -1          0.1        l</span></span>
<span><span class="co">#&gt; 2  2 ~PC1 + PC2 -1          1.0        l</span></span>
<span><span class="co">#&gt; 3  3 ~PC1 + PC2 -1          2.0        l</span></span>
<span><span class="co">#&gt; 4  4 ~PC1 + PC2 -1          3.0        l</span></span>
<span><span class="co">#&gt; 5  5 ~PC1 + PC2 -1          5.0        l</span></span>
<span><span class="co">#&gt; 6  6 ~PC1 + PC3 -1          5.0        l</span></span>
<span></span>
<span><span class="co"># Explore variables distribution</span></span>
<span><span class="va">calib_hist_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_calibration_hist.html">explore_calibration_hist</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d_pca</span>, raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                                           include_m <span class="op">=</span> <span class="cn">TRUE</span>, breaks <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_calibration_hist.html">plot_calibration_hist</a></span><span class="op">(</span>explore_calibration <span class="op">=</span> <span class="va">calib_hist_pca</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/explore%20hist-1.png" class="r-plt" alt="" width="70%"></p>
<p><br></p>
</div>
<div class="section level4">
<h4 id="external-pca">External PCA<a class="anchor" aria-label="anchor" href="#external-pca"></a>
</h4>
<p>Users can choose to perform a PCA with their data by using the
<code><a href="../reference/perform_pca.html">perform_pca()</a></code> function, or one of their preference. Se an
example with <code><a href="../reference/perform_pca.html">perform_pca()</a></code> below:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># PCA with raw raster variables</span></span>
<span><span class="va">pca_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/perform_pca.html">perform_pca</a></span><span class="op">(</span>raster_variables <span class="op">=</span> <span class="va">var</span>, exclude_from_pca <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                       center <span class="op">=</span> <span class="cn">TRUE</span>, scale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pca_var</span><span class="op">$</span><span class="va">env</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/do%20PCA-1.png" class="r-plt" alt="" width="70%"></p>
<p><br></p>
<p>Now, let’s use the PCs generated by <code><a href="../reference/perform_pca.html">perform_pca()</a></code> to
prepare the data:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data for maxnet model using PCA variables</span></span>
<span><span class="va">d_pca_extern</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                             occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                             x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                             raster_variables <span class="op">=</span> <span class="va">pca_var</span><span class="op">$</span><span class="va">env</span>,  <span class="co"># Output of perform_pca()</span></span>
<span>                             do_pca <span class="op">=</span> <span class="cn">FALSE</span>,  <span class="co"># Set to FALSE because variables are PCs</span></span>
<span>                             species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                             categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>, </span>
<span>                             n_background <span class="op">=</span> <span class="fl">1000</span>, </span>
<span>                             partition_method <span class="op">=</span> <span class="st">"kfolds"</span>,</span>
<span>                             features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                             r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 43 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span>
<span></span>
<span><span class="co"># Check the object</span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">d_pca_extern</span><span class="op">)</span></span>
<span><span class="co">#&gt; prepared_data object summary</span></span>
<span><span class="co">#&gt; ============================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of Records: 1008 </span></span>
<span><span class="co">#&gt;   - Presence: 51 </span></span>
<span><span class="co">#&gt;   - Background: 957 </span></span>
<span><span class="co">#&gt; Partition Method: kfolds </span></span>
<span><span class="co">#&gt;   - Number of kfolds: 4 </span></span>
<span><span class="co">#&gt; Continuous Variables:</span></span>
<span><span class="co">#&gt;   - PC1, PC2, PC3, PC4 </span></span>
<span><span class="co">#&gt; Categorical Variables:</span></span>
<span><span class="co">#&gt;   - SoilType </span></span>
<span><span class="co">#&gt; PCA Information: PCA not performed</span></span>
<span><span class="co">#&gt; Weights: No weights provided</span></span>
<span><span class="co">#&gt; Calibration Parameters:</span></span>
<span><span class="co">#&gt;   - Algorithm: maxnet </span></span>
<span><span class="co">#&gt;   - Number of candidate models: 610 </span></span>
<span><span class="co">#&gt;   - Features classes (responses): l, q, p, lq, lqp </span></span>
<span><span class="co">#&gt;   - Regularization multipliers: 0.1, 1, 2, 3, 5</span></span>
<span></span>
<span><span class="co"># Check formula grid</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d_pca_extern</span><span class="op">$</span><span class="va">formula_grid</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ID      Formulas R_multiplier Features</span></span>
<span><span class="co">#&gt; 1  1 ~PC1 + PC2 -1          0.1        l</span></span>
<span><span class="co">#&gt; 2  2 ~PC1 + PC2 -1          1.0        l</span></span>
<span><span class="co">#&gt; 3  3 ~PC1 + PC2 -1          2.0        l</span></span>
<span><span class="co">#&gt; 4  4 ~PC1 + PC2 -1          3.0        l</span></span>
<span><span class="co">#&gt; 5  5 ~PC1 + PC2 -1          5.0        l</span></span>
<span><span class="co">#&gt; 6  6 ~PC1 + PC3 -1          5.0        l</span></span></code></pre></div>
<p><br></p>
<p>Note that since PCA was performed externally,
<code>do_pca = FALSE</code> is set in <code><a href="../reference/prepare_data.html">prepare_data()</a></code>. This
is crucial because setting it to <code>TRUE</code> would incorrectly
apply PCA to variables that are <em>already</em> PCs. The
<code>prepared_data</code> object in this scenario does not store any
PCA-related information. Therefore, users <strong>must provide
PCs</strong> instead of raw raster variables when projecting models.</p>
<p><br></p>
</div>
</div>
<div class="section level3">
<h3 id="using-external-data-partitions">Using external data partitions<a class="anchor" aria-label="anchor" href="#using-external-data-partitions"></a>
</h3>
<p>The functions <code><a href="../reference/prepare_data.html">prepare_data()</a></code> and
<code><a href="../reference/prepare_user_data.html">prepare_user_data()</a></code> in the <code>kuenm2</code> package
include four built-in methods for data partitioning:</p>
<ul>
<li><p><strong>“kfolds”</strong>: Splits the dataset into <em>K</em>
subsets (folds) of approximately equal size. In each partition, one fold
is used as the test set, while the remaining folds are combined to form
the training set.</p></li>
<li><p><strong>“bootstrap”</strong>: Creates the training dataset by
sampling observations from the original dataset <em>with
replacement</em> (i.e., the same observation can be selected multiple
times). The test set consists of the observations that were not selected
in that specific replicate.</p></li>
<li><p><strong>“subsample”</strong>: Similar to bootstrap, but the
training set is created by sampling <em>without replacement</em> (i.e.,
each observation is selected once). The test set includes the
observations not selected for training.</p></li>
</ul>
<p>Other methods for data partitioning are also available, including
those based on spatial rules (<a href="https://onlinelibrary.wiley.com/doi/pdf/10.1111/jbi.12227" class="external-link">Radosavljevic
and Anderson, 2014</a>). Although <code>kuenm2</code> does not currently
implement spatial partitioning techniques, it is possible to use the
ones implemented in other R packages. After partitioning data using
other packages, those results can be used to replace the
<code>part_data</code> section in the <code>prepared_data</code> object
from <code>kuenm2</code>.</p>
<p><br></p>
<div class="section level4">
<h4 id="enmeval-partitions">ENMeval partitions<a class="anchor" aria-label="anchor" href="#enmeval-partitions"></a>
</h4>
<p>The ENMeval package (<a href="https://besjournals.onlinelibrary.wiley.com/doi/pdfdirect/10.1111/2041-210X.13628" class="external-link">Kass
et al. 2021</a>) provides three spatial partitioning methods:</p>
<ul>
<li><p><strong>Spatial block</strong>: Divides occurrence data into four
groups based on latitude and longitude, aiming for groups of roughly
equal number of occurrences.</p></li>
<li><p><strong>Checkerboard 1 (basic)</strong>: Generates a checkerboard
grid over the study area and assigns points to groups based on their
location in the grid.</p></li>
<li><p><strong>Checkerboard 2 (hierarchical)</strong>: Aggregates the
input raster at two hierarchical spatial scales using specified
aggregation factors. Points are then grouped based on their position in
the resulting hierarchical checkerboard.</p></li>
</ul>
<p>Let’s use the <strong>spatial block</strong> method as an example. We
will use the object <code>d</code>, <code>prepared_data</code> created
in previous steps.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install ENMeval if not already installed</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://jamiemkass.github.io/ENMeval/" class="external-link">"ENMeval"</a></span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"ENMeval"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Extract calibration data from the prepared_data object and </span></span>
<span><span class="co"># separate presence and background records</span></span>
<span><span class="va">calib_occ</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">data_xy</span><span class="op">[</span><span class="va">d</span><span class="op">$</span><span class="va">calibration_data</span><span class="op">$</span><span class="va">pr_bg</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>  <span class="co"># Presences</span></span>
<span><span class="va">calib_bg</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">data_xy</span><span class="op">[</span><span class="va">d</span><span class="op">$</span><span class="va">calibration_data</span><span class="op">$</span><span class="va">pr_bg</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span>  <span class="co"># Background</span></span>
<span></span>
<span><span class="co"># Apply spatial block partitioning using ENMeval</span></span>
<span><span class="va">enmeval_block</span> <span class="op">&lt;-</span> <span class="fu">ENMeval</span><span class="fu">::</span><span class="fu">get.block</span><span class="op">(</span>occs <span class="op">=</span> <span class="va">calib_occ</span>, bg <span class="op">=</span> <span class="va">calib_bg</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect the structure of the output</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">enmeval_block</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ occs.grp: num [1:51] 1 1 2 2 1 4 2 2 4 2 ...</span></span>
<span><span class="co">#&gt;  $ bg.grp  : num [1:957] 2 4 4 1 3 3 3 1 1 3 ...</span></span></code></pre></div>
<p><br></p>
<p>The output of <code>get.block()</code> is a list with two elements:
<code>occs.grp</code> and <code>bg.grp</code>. The <code>occs.grp</code>
vector is for occurrence records and <code>bg.grp</code> for background
points. Both vectors contain numeric values from 1 to 4, indicating the
spatial group.</p>
<p><code>kuenm2</code> stores partitioned data as a <strong>list of
vectors</strong>, in which each vector is a partition, containing the
<strong>indices of points left out for testing</strong>. The indices
include both presence and background points.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">part_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ Partition_1: num [1:253] 1 3 12 13 14 20 24 25 34 43 ...</span></span>
<span><span class="co">#&gt;  $ Partition_2: num [1:252] 5 7 8 10 15 17 23 27 31 33 ...</span></span>
<span><span class="co">#&gt;  $ Partition_3: num [1:251] 4 9 19 21 28 29 30 32 35 36 ...</span></span>
<span><span class="co">#&gt;  $ Partition_4: num [1:252] 2 6 11 16 18 22 26 37 38 40 ...</span></span></code></pre></div>
<p><br></p>
<p>We can convert the spatial group information stored in
<code>enmeval_block</code> into a list compatible with
<code>kuenm2</code>:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Identify unique spatial blocks</span></span>
<span><span class="va">id_blocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">enmeval_block</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a list of test indices for each spatial block</span></span>
<span><span class="va">new_part_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">id_blocks</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Indices of occurrence records in group i</span></span>
<span>  <span class="va">rep_i_presence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">enmeval_block</span><span class="op">$</span><span class="va">occs.grp</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Indices of background records in group i</span></span>
<span>  <span class="va">rep_i_bg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">enmeval_block</span><span class="op">$</span><span class="va">bg.grp</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># To get the right indices for background, </span></span>
<span>  <span class="co"># we need to sum the total number of records to background indices</span></span>
<span>  <span class="va">rep_i_bg</span> <span class="op">&lt;-</span> <span class="va">rep_i_bg</span> <span class="op">+</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">occ_data</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Combine presence and background indices for the test set</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rep_i_presence</span>, <span class="va">rep_i_bg</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign names to each partition</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">new_part_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Partition_"</span>, <span class="va">id_blocks</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect the structure of the new partitioned data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">new_part_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ Partition_1: int [1:406] 1 2 5 12 13 14 15 29 31 42 ...</span></span>
<span><span class="co">#&gt;  $ Partition_2: int [1:108] 3 4 7 8 10 16 18 22 27 36 ...</span></span>
<span><span class="co">#&gt;  $ Partition_3: int [1:367] 11 19 20 21 24 26 30 33 34 38 ...</span></span>
<span><span class="co">#&gt;  $ Partition_4: int [1:127] 6 9 17 23 25 28 32 35 37 39 ...</span></span></code></pre></div>
<p><br></p>
<p>We now have a list containing four vectors, each storing the indices
of test data defined using the <code>get.block()</code> function from
the <code>ENMeval</code> package. The final step is to replace the
original <code>part_data</code> in the <code>prepared_data</code> object
with <code>new_part_data</code>. We should also update the partitioning
method to reflect this change.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Replace the original partition data with the new spatial blocks</span></span>
<span><span class="va">d_spatial_block</span> <span class="op">&lt;-</span> <span class="va">d</span></span>
<span><span class="va">d_spatial_block</span><span class="op">$</span><span class="va">part_data</span> <span class="op">&lt;-</span> <span class="va">new_part_data</span></span>
<span></span>
<span><span class="co"># Update the partitioning method to reflect the new approach</span></span>
<span><span class="va">d_spatial_block</span><span class="op">$</span><span class="va">partition_method</span> <span class="op">&lt;-</span> <span class="st">"Spatial block (ENMeval)"</span>  <span class="co"># Any name works</span></span>
<span></span>
<span><span class="co"># Print the updated prepared_data object</span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">d_spatial_block</span><span class="op">)</span></span>
<span><span class="co">#&gt; prepared_data object summary</span></span>
<span><span class="co">#&gt; ============================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of Records: 1008 </span></span>
<span><span class="co">#&gt;   - Presence: 51 </span></span>
<span><span class="co">#&gt;   - Background: 957 </span></span>
<span><span class="co">#&gt; Partition Method: Spatial block (ENMeval) </span></span>
<span><span class="co">#&gt; Continuous Variables:</span></span>
<span><span class="co">#&gt;   - bio_1, bio_7, bio_12, bio_15 </span></span>
<span><span class="co">#&gt; Categorical Variables:</span></span>
<span><span class="co">#&gt;   - SoilType </span></span>
<span><span class="co">#&gt; PCA Information: PCA not performed</span></span>
<span><span class="co">#&gt; Weights: No weights provided</span></span>
<span><span class="co">#&gt; Calibration Parameters:</span></span>
<span><span class="co">#&gt;   - Algorithm: maxnet </span></span>
<span><span class="co">#&gt;   - Number of candidate models: 300 </span></span>
<span><span class="co">#&gt;   - Features classes (responses): l, q, lq, lqp </span></span>
<span><span class="co">#&gt;   - Regularization multipliers: 0.1, 2, 1</span></span></code></pre></div>
<p><br></p>
<p>Let’s check the spatial distribution of the partitioned data:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Explore data partitioning in geography</span></span>
<span><span class="va">geo_block</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_partition_geo.html">explore_partition_geo</a></span><span class="op">(</span><span class="va">d_spatial_block</span>, raster_variables <span class="op">=</span> <span class="va">var</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot data partition in geography</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">geo_block</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Presence"</span>, <span class="st">"Background"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/plot%20spatial%20block-1.png" class="r-plt" alt="" width="95%"></p>
<p><br></p>
<p>Because environmental conditions often vary by region, using spatial
blocks increases the chances of having testing records outside training
environmental ranges. Let’s explore this effect using the
<code>prepared_data</code> object, partitioned with <code>ENMeval</code>
spatial blocks.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run extrapolation risk analysis</span></span>
<span><span class="va">mop_blocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_partition_extrapolation.html">explore_partition_extrapolation</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d_spatial_block</span>, </span>
<span>                                              include_test_background <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check some testing records with values outside training ranges</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mop_blocks</span><span class="op">$</span><span class="va">Mop_results</span><span class="op">[</span><span class="va">mop_blocks</span><span class="op">$</span><span class="va">Mop_results</span><span class="op">$</span><span class="va">n_var_out</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;       Partition pr_bg         x         y mop_distance inside_range n_var_out</span></span>
<span><span class="co">#&gt; 87  Partition_1     0 -50.75000 -30.75000     12.57765        FALSE         2</span></span>
<span><span class="co">#&gt; 129 Partition_1     0 -51.75000 -29.91667     10.91112        FALSE         2</span></span>
<span><span class="co">#&gt; 193 Partition_1     0 -53.41667 -27.08333     43.59743        FALSE         2</span></span>
<span><span class="co">#&gt; 199 Partition_1     0 -52.41667 -26.75000    171.15194        FALSE         2</span></span>
<span><span class="co">#&gt; 252 Partition_1     0 -51.58333 -30.75000     15.76803        FALSE         2</span></span>
<span><span class="co">#&gt; 261 Partition_1     0 -53.25000 -27.08333     43.59052        FALSE         2</span></span>
<span><span class="co">#&gt;     towards_low towards_high SoilType</span></span>
<span><span class="co">#&gt; 87       bio_15         &lt;NA&gt;       21</span></span>
<span><span class="co">#&gt; 129      bio_15         &lt;NA&gt;       21</span></span>
<span><span class="co">#&gt; 193      bio_15        bio_7     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 199      bio_15       bio_12     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 252      bio_15         &lt;NA&gt;       21</span></span>
<span><span class="co">#&gt; 261      bio_15        bio_7     &lt;NA&gt;</span></span>
<span></span>
<span><span class="co"># Check simple extrapolation in geographic space</span></span>
<span><span class="fu"><a href="../reference/plot_explore_partition.html">plot_explore_partition</a></span><span class="op">(</span>explore_partition <span class="op">=</span> <span class="va">mop_blocks</span>, space <span class="op">=</span> <span class="st">"G"</span>, </span>
<span>                       type_of_plot <span class="op">=</span> <span class="st">"simple"</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/unnamed-chunk-6-1.png" class="r-plt" alt="" width="75%"></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Now in environmental space</span></span>
<span><span class="fu"><a href="../reference/plot_explore_partition.html">plot_explore_partition</a></span><span class="op">(</span>explore_partition <span class="op">=</span> <span class="va">mop_blocks</span>, space <span class="op">=</span> <span class="st">"E"</span>, </span>
<span>                       type_of_plot <span class="op">=</span> <span class="st">"simple"</span>, </span>
<span>                       variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bio_7"</span>, <span class="st">"bio_15"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/unnamed-chunk-6-2.png" class="r-plt" alt="" width="75%"></p>
<p><br></p>
<p>Note that in partition 1, some occurrence records fall outside the
envrionmental range of the other partitions (the same happens with many
background records).</p>
<p><br></p>
</div>
<div class="section level4">
<h4 id="flexsdm-partitions">flexsdm partitions<a class="anchor" aria-label="anchor" href="#flexsdm-partitions"></a>
</h4>
<p>The package <code>flexsdm</code> (<a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13874" class="external-link">Velazco
et al. 2022</a>) also offers multiple partitioning methods. We will use
the method spatial block cross-validation. In this method, the number
and size of blocks is optimized internally considering spatial
autocorrelation, environmental similarity, and the number of presence
and background records within each partition. For more details, see <a href="https://sjevelazco.github.io/flexsdm/articles/v01_pre_modeling.html#data-partitioning" class="external-link">Data
partitioning at the package website</a>.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install flexsdm if not already installed</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st">"flexsdm"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://remotes.r-lib.org" class="external-link">"remotes"</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"sjevelazco/flexsdm"</span><span class="op">)</span>  <span class="co"># needs compilation tools to work</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Combine calibration data with spatial coordinates</span></span>
<span><span class="va">calib_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">data_xy</span>, <span class="va">d</span><span class="op">$</span><span class="va">calibration_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split data in test and train using flexsdm</span></span>
<span><span class="va">flexsdm_block</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu">part_sblock</span><span class="op">(</span>env_layer <span class="op">=</span> <span class="va">var</span>, data <span class="op">=</span> <span class="va">calib_data</span>, </span>
<span>                                      x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>, pr_ab <span class="op">=</span> <span class="st">"pr_bg"</span>, </span>
<span>                                      min_res_mult <span class="op">=</span> <span class="fl">1</span>, max_res_mult <span class="op">=</span> <span class="fl">500</span>, </span>
<span>                                      num_grids <span class="op">=</span> <span class="fl">30</span>, n_part <span class="op">=</span> <span class="fl">4</span>, </span>
<span>                                      prop <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; The following grid cell sizes will be tested:</span></span>
<span><span class="co">#&gt; 0.17 | 3.03 | 5.9 | 8.77 | 11.64 | 14.51 | 17.37 | 20.24 | 23.11 | 25.98 | </span></span>
<span><span class="co">#&gt; 28.84 | 31.71 | 34.58 | 37.45 | 40.32 | 43.18 | 46.05 | 48.92 | 51.79 | </span></span>
<span><span class="co">#&gt; 54.66 | 57.52 | 60.39 | 63.26 | 66.13 | 68.99 | 71.86 | 74.73 | 77.6 | </span></span>
<span><span class="co">#&gt; 80.47 | 83.33</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Creating basic raster mask...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Searching for the optimal grid size...</span></span>
<span></span>
<span><span class="co"># See the structure of the object</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">flexsdm_block</span><span class="op">$</span><span class="va">part</span><span class="op">)</span></span>
<span><span class="co">#&gt; Classes ‘tbl_df’, ‘tbl’ and 'data.frame':    1008 obs. of  4 variables:</span></span>
<span><span class="co">#&gt;  $ x    : num  -51.3 -50.6 -49.3 -49.8 -50.2 ...</span></span>
<span><span class="co">#&gt;  $ y    : num  -29 -27.6 -27.8 -26.9 -28.2 ...</span></span>
<span><span class="co">#&gt;  $ pr_ab: num  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ .part: int  3 1 3 2 3 3 1 4 4 3 ...</span></span></code></pre></div>
<p><br></p>
<p>The output from <code>flexsdm</code> differs from that of
<code>ENMeval</code>. Instead of returning a list with separate vectors
of spatial group IDs, <code>flexsdm</code> appends the group assignments
as a new column in the <code>part</code> element of its output.</p>
<p>As with the ENMeval example, we can transform the spatial group
information stored in <code>flexsdm_block</code> into a format
compatible with <code>kuenm2</code>:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Identify unique spatial blocks from flexsdm output</span></span>
<span><span class="va">id_blocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">flexsdm_block</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">.part</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a list of test indices for each spatial block</span></span>
<span><span class="va">new_part_data_flexsdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">id_blocks</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Indices of occurrences and background points in group i</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">flexsdm_block</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">.part</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign names to each partition partition</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">new_part_data_flexsdm</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Partition_"</span>, <span class="va">id_blocks</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect the structure of the new partitioned data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">new_part_data_flexsdm</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ Partition_1: int [1:248] 2 7 13 21 24 25 26 27 36 40 ...</span></span>
<span><span class="co">#&gt;  $ Partition_2: int [1:266] 4 12 15 17 18 19 29 31 32 33 ...</span></span>
<span><span class="co">#&gt;  $ Partition_3: int [1:247] 1 3 5 6 10 16 20 28 34 35 ...</span></span>
<span><span class="co">#&gt;  $ Partition_4: int [1:247] 8 9 11 14 22 23 30 37 38 41 ...</span></span>
<span></span>
<span><span class="co"># Replace the partition data in the prepared_data object</span></span>
<span><span class="va">d_block_flexsdm</span> <span class="op">&lt;-</span> <span class="va">d</span></span>
<span><span class="va">d_block_flexsdm</span><span class="op">$</span><span class="va">part_data</span> <span class="op">&lt;-</span> <span class="va">new_part_data_flexsdm</span></span>
<span></span>
<span><span class="co"># Update the partition method description</span></span>
<span><span class="va">d_block_flexsdm</span><span class="op">$</span><span class="va">partition_method</span> <span class="op">&lt;-</span> <span class="st">"Spatial block (flexsdm)"</span>  <span class="co"># any name works</span></span>
<span></span>
<span><span class="co"># Display the updated prepared_data object</span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">d_block_flexsdm</span><span class="op">)</span></span>
<span><span class="co">#&gt; prepared_data object summary</span></span>
<span><span class="co">#&gt; ============================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of Records: 1008 </span></span>
<span><span class="co">#&gt;   - Presence: 51 </span></span>
<span><span class="co">#&gt;   - Background: 957 </span></span>
<span><span class="co">#&gt; Partition Method: Spatial block (flexsdm) </span></span>
<span><span class="co">#&gt; Continuous Variables:</span></span>
<span><span class="co">#&gt;   - bio_1, bio_7, bio_12, bio_15 </span></span>
<span><span class="co">#&gt; Categorical Variables:</span></span>
<span><span class="co">#&gt;   - SoilType </span></span>
<span><span class="co">#&gt; PCA Information: PCA not performed</span></span>
<span><span class="co">#&gt; Weights: No weights provided</span></span>
<span><span class="co">#&gt; Calibration Parameters:</span></span>
<span><span class="co">#&gt;   - Algorithm: maxnet </span></span>
<span><span class="co">#&gt;   - Number of candidate models: 300 </span></span>
<span><span class="co">#&gt;   - Features classes (responses): l, q, lq, lqp </span></span>
<span><span class="co">#&gt;   - Regularization multipliers: 0.1, 2, 1</span></span></code></pre></div>
<p><br></p>
<p>Let’s check the spatial distribution of the partitioned data:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Explore data partitioning in geography</span></span>
<span><span class="va">geo_block_flexsdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_partition_geo.html">explore_partition_geo</a></span><span class="op">(</span><span class="va">d_block_flexsdm</span>, </span>
<span>                                           raster_variables <span class="op">=</span> <span class="va">var</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot data partition in geography</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">geo_block_flexsdm</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Presence"</span>, <span class="st">"Background"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/plot%20spatial%20block%20flexsdm-1.png" class="r-plt" alt="" width="95%"></p>
<p><br></p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reset plotting parameters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">original_par</span><span class="op">)</span> </span></code></pre></div>
<p><br></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="saving-prepared-data">Saving prepared data<a class="anchor" aria-label="anchor" href="#saving-prepared-data"></a>
</h2>
<p>The <code>prepared_data</code> object is crucial for the next step in
the ENM workflow in <code>kuenm2</code>, model calibration. As this
object is essentially a list, users can save it to a local directory
using <code><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">saveRDS()</a></code>. Saving the object facilitates loading it
back into your R session later using <code><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS()</a></code>. See an
example below:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set directory to save (here, in a temporary directory)</span></span>
<span><span class="va">dir_to_save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save the data</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">d</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_to_save</span>, <span class="st">"Data.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Import data</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_to_save</span>, <span class="st">"Data.rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Weverton C. F. Trindade, Luis F. Arias-Giraldo, Luis Osorio-Olvera, A. Townsend Peterson, Marlon E. Cobos.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
