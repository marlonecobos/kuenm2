<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Prepare Data for Model Calibration • kuenm2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Prepare Data for Model Calibration">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">kuenm2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.10</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/basic_bata_cleaning.html">Occurrene Data Cleaning</a></li>
    <li><a class="dropdown-item" href="../articles/model_calibration.html">Model Calibration</a></li>
    <li><a class="dropdown-item" href="../articles/model_exploration.html">Fit and Explore Selected Models</a></li>
    <li><a class="dropdown-item" href="../articles/model_predictions.html">Predict models to single scenario</a></li>
    <li><a class="dropdown-item" href="../articles/prepare_data.html">Prepare Data for Model Calibration</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Prepare Data for Model Calibration</h1>
            
      

      <div class="d-none name"><code>prepare_data.Rmd</code></div>
    </div>

    
    
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#getting-ready">Getting ready</a></li>
<li>
<a href="#prepare-data">Prepare data</a>
<ul>
<li><a href="#import-data">Import data</a></li>
<li><a href="#first-steps-in-preparing-data">First steps in preparing
data</a></li>
<li><a href="#exploring-calibration-data">Exploring calibration
data</a></li>
<li>
<a href="#using-a-bias-file">Using a bias file</a><br>
</li>
<li><a href="#pca-for-variables">PCA for variables</a></li>
</ul>
</li>
<li><a href="#prepare-user-pre-processed-data">Prepare user
pre-processed data</a></li>
<li><a href="#saving-a-prepared_data-object">Saving a prepared_data
object</a></li>
</ul>
<hr>
<div class="section level2">
<h2 id="description">Description<a class="anchor" aria-label="anchor" href="#description"></a>
</h2>
<p>Before starting the ENM process, data must be formatted in a specific
structure required by functions in <strong>kuenm2</strong>. This
vignette guides users through the steps necessary to prepare occurrence
data and environmental predictors using built-in tools. It covers the
use of <code><a href="../reference/prepare_data.html">prepare_data()</a></code> and <code><a href="../reference/prepare_user_data.html">prepare_user_data()</a></code>
to generate standardized objects, which are essential for model
calibration. The vignette also demonstrates options for applying PCA,
incorporating sampling bias, and saving prepared data for later use.</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="getting-ready">Getting ready<a class="anchor" aria-label="anchor" href="#getting-ready"></a>
</h2>
<p>If <strong>kuenm2</strong> has not been installed yet, please do so.
See the <a href="../index.html">Main guide</a> for installation
instructions. See the <a href="/articles/basic_data_cleaning.html">basic
data cleaning guide</a> for some steps on cleaning data.</p>
<p>Use the following lines of code to load <strong>kuenm2</strong> and
any other required packages, and define a working directory (if needed).
In general, setting a working directory in R is considered good
practice, as it provides better control over where files are read from
or saved to. If users are not working within an R project, we recommend
setting a working directory, since at least one file will be saved at
later stages of this guide.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marlonecobos.github.io/kuenm2/">kuenm2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Current directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define new directory</span></span>
<span><span class="co">#setwd("YOUR/DIRECTORY")  # uncomment this line if setting a new directory</span></span></code></pre></div>
<p><br></p>
</div>
<div class="section level2">
<h2 id="prepare-data">Prepare data<a class="anchor" aria-label="anchor" href="#prepare-data"></a>
</h2>
<div class="section level3">
<h3 id="import-data">Import data<a class="anchor" aria-label="anchor" href="#import-data"></a>
</h3>
<p>We will use occurrence records provided within the
<strong>kuenm2</strong> package. Most example data in the package is
derived from <a href="https://doi.org/10.1111/ddi.13931" class="external-link">Trindade &amp;
Marques (2024)</a>. The <code>occ_data</code> object contains 51
occurrences of <em>Myrcia hatschbachii</em>, a tree endemic to Southern
Brazil. Although this example data set has three columns (species, x,
and y), users’ input data only requires two numeric columns with
longitude and latitude coordinates.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import occurrences</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">occ_data</span>, package <span class="op">=</span> <span class="st">"kuenm2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check data structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">occ_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    51 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;  $ species: chr  "Myrcia hatschbachii" "Myrcia hatschbachii" "Myrcia hatschbachii" "Myrcia hatschbachii" ...</span></span>
<span><span class="co">#&gt;  $ x      : num  -51.3 -50.6 -49.3 -49.8 -50.2 ...</span></span>
<span><span class="co">#&gt;  $ y      : num  -29 -27.6 -27.8 -26.9 -28.2 ...</span></span></code></pre></div>
<p><br></p>
<p>As predictor variables, we will use other data included in the
package. This data set comprises four bioclimatic variables from <a href="https://worldclim.org/data/bioclim.html" class="external-link">WorldClim 2.1</a> at 10
arc-minute resolution, and a categorical variable (SoilType) from <a href="https://soilgrids.org/" class="external-link">SoilGrids</a> resampled to 10 arc-minutes.
All variables have been masked using a polygon that delimits the area
for model calibration, which was generated by drawing a minimum convex
polygon around the records with a 300 km buffer.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import raster layers</span></span>
<span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Current_variables.tif"</span>, package <span class="op">=</span> <span class="st">"kuenm2"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check variables</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/Load%20variables-1.png" width="672"></p>
<p><br></p>
<p>Visualize occurrences records in geography:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize occurrences on one variable</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var</span><span class="op">[[</span><span class="st">"bio_1"</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Bio 1"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">occ_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="first-steps-in-preparing-data">First steps in preparing data<a class="anchor" aria-label="anchor" href="#first-steps-in-preparing-data"></a>
</h3>
<p>The function <code><a href="../reference/prepare_data.html">prepare_data()</a></code> is central to getting data
ready for model calibration. It handles several key steps:</p>
<ul>
<li>
<strong>Defining the algorithm</strong>: Users can choose between
<code>maxnet</code> or <code>glm</code>.</li>
<li>
<strong>Generating background points</strong>: Background points
area sampled from raster layers, unless provided by the user. These
points serve as a reference to contrast presence records.</li>
<li>
<strong>Principal component analysis (PCA)</strong>: An optional
step that can be applied to the set of predictors in PCA.</li>
<li>
<strong>Preparing calibration data</strong>: Presence records and
background points are associate with predictor values and put together
in a <code>data.frame</code> to be used in the ENM.</li>
<li>
<strong>Data partitioning</strong>: The function divides your data
using <code>k-folds</code> to prepare training and testing sets via a
cross-validation process.</li>
<li>
<strong>Defining grid of model parameters</strong>: This helps
setting up combinations of feature classes (FCs), regularization
multiplier (RM) values (for Maxnet), and sets of predictor variables. An
explanation of the roles of RMs and FCs in Maxent models see <a href="https://doi.org/10.1111/j.1600-0587.2013.07872.x" class="external-link">Merow et
al. 2013</a>.</li>
</ul>
<p>As with any function, we recommend consulting the documentation for
more detailed explanations (e.g., <code><a href="../reference/prepare_data.html">help(prepare_data)</a></code>). Now,
let’s prepare our data for model calibration using
<code><a href="../reference/prepare_data.html">prepare_data()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data for maxnet model</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                  occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                  x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                  raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                  species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                  categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                  n_background <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                  features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                  r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 43 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span></code></pre></div>
<p><br></p>
<p>The <code><a href="../reference/prepare_data.html">prepare_data()</a></code> function returns a
<code>prepared_data</code> object, which is a list containing various
essential pieces of information fro model calibration. Below is an
example of how the object is printed to summarize its components.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt; prepared_data object summary</span></span>
<span><span class="co">#&gt; ============================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of Records: 1008 </span></span>
<span><span class="co">#&gt;   - Presence: 51 </span></span>
<span><span class="co">#&gt;   - Background: 957 </span></span>
<span><span class="co">#&gt; Training-Testing Method:</span></span>
<span><span class="co">#&gt;   - k-fold Cross-validation: 4 folds</span></span>
<span><span class="co">#&gt; Continuous Variables:</span></span>
<span><span class="co">#&gt;   - bio_1, bio_7, bio_12, bio_15 </span></span>
<span><span class="co">#&gt; Categorical Variables:</span></span>
<span><span class="co">#&gt;   - SoilType </span></span>
<span><span class="co">#&gt; PCA Information: PCA not performed</span></span>
<span><span class="co">#&gt; Weights: No weights provided</span></span>
<span><span class="co">#&gt; Calibration Parameters:</span></span>
<span><span class="co">#&gt;   - Algorithm: maxnet </span></span>
<span><span class="co">#&gt;   - Number of candidate models: 610 </span></span>
<span><span class="co">#&gt;   - Features classes (responses): l, q, p, lq, lqp </span></span>
<span><span class="co">#&gt;   - Regularization multipliers: 0.1, 1, 2, 3, 5</span></span></code></pre></div>
<p><br></p>
<p>The parts of the <code>prepared_data</code> object can be explored in
further detail by indexing them as in the following example.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># See first rows of calibration data</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">calibration_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   pr_bg    bio_1    bio_7 bio_12   bio_15 SoilType</span></span>
<span><span class="co">#&gt; 1     1 16.49046 18.66075   1778 12.96107       19</span></span>
<span><span class="co">#&gt; 2     1 15.46644 19.65775   1560 14.14697       19</span></span>
<span><span class="co">#&gt; 3     1 15.70560 17.99450   1652 23.27548        6</span></span>
<span><span class="co">#&gt; 4     1 17.78899 19.55600   1597 18.91694        1</span></span>
<span><span class="co">#&gt; 5     1 15.50116 18.30750   1497 15.39440       19</span></span>
<span><span class="co">#&gt; 7     1 17.42421 17.25875   1760 34.17664        6</span></span>
<span></span>
<span><span class="co"># See first rows of formula grid</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">formula_grid</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ID           Formulas R_multiplier Features</span></span>
<span><span class="co">#&gt; 1  1  ~bio_1 + bio_7 -1          0.1        l</span></span>
<span><span class="co">#&gt; 2  2  ~bio_1 + bio_7 -1          1.0        l</span></span>
<span><span class="co">#&gt; 3  3  ~bio_1 + bio_7 -1          2.0        l</span></span>
<span><span class="co">#&gt; 4  4  ~bio_1 + bio_7 -1          3.0        l</span></span>
<span><span class="co">#&gt; 5  5  ~bio_1 + bio_7 -1          5.0        l</span></span>
<span><span class="co">#&gt; 6  6 ~bio_1 + bio_12 -1          5.0        l</span></span></code></pre></div>
<p><br></p>
<p>By default, <code><a href="../reference/prepare_data.html">prepare_data()</a></code> prepares an object for
fitting models using <code>maxnet</code>. However, this can be changed
to use GLM instead. When using GLM, it is not necessary to set
regularization multipliers, as this algorithm does not utilize them.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d_glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"glm"</span>,</span>
<span>                      occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                      x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                      raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                      species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                      categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                      n_background <span class="op">=</span> <span class="fl">300</span>,</span>
<span>                      features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                      r_multiplier <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="co">#Not necessary with glms</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 8 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span>
<span><span class="co">#Print object</span></span>
<span><span class="va">d_glm</span></span>
<span><span class="co">#&gt; prepared_data object summary</span></span>
<span><span class="co">#&gt; ============================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of Records: 343 </span></span>
<span><span class="co">#&gt;   - Presence: 51 </span></span>
<span><span class="co">#&gt;   - Background: 292 </span></span>
<span><span class="co">#&gt; Training-Testing Method:</span></span>
<span><span class="co">#&gt;   - k-fold Cross-validation: 4 folds</span></span>
<span><span class="co">#&gt; Continuous Variables:</span></span>
<span><span class="co">#&gt;   - bio_1, bio_7, bio_12, bio_15 </span></span>
<span><span class="co">#&gt; Categorical Variables:</span></span>
<span><span class="co">#&gt;   - SoilType </span></span>
<span><span class="co">#&gt; PCA Information: PCA not performed</span></span>
<span><span class="co">#&gt; Weights: No weights provided</span></span>
<span><span class="co">#&gt; Calibration Parameters:</span></span>
<span><span class="co">#&gt;   - Algorithm: glm </span></span>
<span><span class="co">#&gt;   - Number of candidate models: 122 </span></span>
<span><span class="co">#&gt;   - Features classes (responses): l, q, p, lq, lqp</span></span></code></pre></div>
<p><br></p>
<p>By default, <code><a href="../reference/prepare_data.html">prepare_data()</a></code> extracts background points
from the entire extent of the provided raster variables. If you have a
species-specific polygon defining the calibration area, you can use it
to mask the raster variables and delimit the calibration area. For
example, let’s create a 100km buffer around the occurrence records:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Convert dataframe with occurrences to SpatVector</span></span>
<span><span class="va">pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">occ_data</span>, geom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="st">"EPSG:4326"</span><span class="op">)</span></span>
<span><span class="co">#Create buffer</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/buffer.html" class="external-link">buffer</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">pts</span>, width <span class="op">=</span> <span class="fl">100000</span><span class="op">)</span> <span class="co">#Width in meters</span></span>
<span><span class="co">#Aggregate buffers</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="co">#Plot buffer</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">occ_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/create%20buffer-1.png" width="672"></p>
<p>Now, let’s use this new polygon to mask the variables within
<code><a href="../reference/prepare_data.html">prepare_data()</a></code>. Let’s also increase the number of
background points to 1,000:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d_buffer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                         occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                         x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                         raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                         mask <span class="op">=</span> <span class="va">b</span>, <span class="co">#Polygon to mask variables</span></span>
<span>                         species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                         categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                         n_background <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                         features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                         r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'n_background' &gt;= initial number of points, using all points.</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 25 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span></code></pre></div>
<p>Note the warning message: <strong>“n_background’ &gt;= initial number
of points, using all points”</strong>. This occurs because, after
masking the variables, the total number of pixels within the buffer is
less than the specified n_background (1,000). In such cases, all
available points within the calibration area will be used as background
points.</p>
<p>In the following examples, we’ll use the object
<code>d_maxnet</code>, which was prepared for the maxnet algorithm
without a mask. However, all functions are compatible with objects
prepared for GLM as well.</p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="exploring-calibration-data">Exploring calibration data<a class="anchor" aria-label="anchor" href="#exploring-calibration-data"></a>
</h3>
<p>Users can visualize the distribution of predictor values for
occurrence records, background points, and the entire calibration area
using histograms. An example is presented below. See full documentation
with <code><a href="../reference/explore_calibration_hist.html">help(explore_calibration_hist)</a></code> and
<code><a href="../reference/plot_explore_calibration.html">help(plot_explore_calibration)</a></code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare histogram data</span></span>
<span><span class="va">calib_hist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_calibration_hist.html">explore_calibration_hist</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d</span>, raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                                       include_m <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot histograms</span></span>
<span><span class="fu"><a href="../reference/plot_explore_calibration.html">plot_explore_calibration</a></span><span class="op">(</span>explore_calibration <span class="op">=</span> <span class="va">calib_hist</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/explore%20histogram-1.png" width="672"></p>
<p>The gray bars represent values across the entire calibration area.
Blue bars show values for the background, while green bars display
values at presence points (magnified by a factor of 2 for improved
visualization). You can customize both the colors and the magnification
factor.</p>
<p><br></p>
<p>Additionally, users can explore the geographic distribution of
occurrence and background points. See full documentation with
<code><a href="../reference/explore_calibration_geo.html">help(explore_calibration_geo)</a></code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_calibration_geo.html">explore_calibration_geo</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d</span>, raster_variables <span class="op">=</span> <span class="va">var</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                               plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/explore%20spatial-1.png" width="672"></p>
<p><br></p>
<p>Note that, by default, background points are selected randomly within
the calibration area. However, users can influence the spatial
distribution of background, increasing or decreasing the probability of
selection in certain regions, by providing a bias file (as demonstrated
in the next section).</p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="using-a-bias-file">Using a bias file<a class="anchor" aria-label="anchor" href="#using-a-bias-file"></a>
</h3>
<p>A bias file is a <code>SpatRaster</code> object that contains values
that will influence the selection of background points within the
calibration area. This can be particularly useful for mitigating
sampling bias, for instance, by incorporating the density of records
from a target group (as discussed in <a href="https://doi.org/10.1046/j.1523-1739.2001.015003648.x" class="external-link">Ponder et
al. 2001</a>, <a href="https://doi.org/10.1046/j.1365-2699.2003.00867.x" class="external-link">Anderson et
al. 2003</a>, and <a href="https://doi.org/10.1111/ddi.13442" class="external-link">Barber et
al. 2020</a>).</p>
<p>The bias file must have the same extent, resolution, and number of
cells as your raster variables, unless a mask is supplied. If a mask is
used, the extent of the bias file should encompass or be larger than the
mask extent.</p>
<p>Let’s illustrate this with an example bias file included in the
package. This <code>SpatRaster</code> has lower values in the center and
higher values towards the borders:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import a bias file</span></span>
<span><span class="va">bias</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"bias_file.tif"</span>, package <span class="op">=</span> <span class="st">"kuenm2"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bias</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/import%20bias%20file-1.png" width="672"></p>
<p><br></p>
<p>We will now use this bias file to prepare two new datasets: one where
the bias effect is “direct” (higher probability in regions with higher
bias values) and another where the effect is “inverse” (higher
probability in regions with lower bias values):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Using bias as a direct effect in sampling</span></span>
<span><span class="va">d_bias_direct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                              occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                              x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                              raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                              species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                              categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                              n_background <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                              bias_file <span class="op">=</span> <span class="va">bias</span>, bias_effect <span class="op">=</span> <span class="st">"direct"</span>,  <span class="co"># bias parameters</span></span>
<span>                              features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                              r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 57 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span>
<span></span>
<span><span class="co"># Using bias as an indirect effect in sampling</span></span>
<span><span class="va">d_bias_inverse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                               occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                               x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                               raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                               species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                               categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                               n_background <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                               bias_file <span class="op">=</span> <span class="va">bias</span>, bias_effect <span class="op">=</span> <span class="st">"inverse"</span>,   <span class="co"># bias parameters</span></span>
<span>                               features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                               r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 45 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span>
<span></span>
<span><span class="co"># Compare background points generated randomly versus with bias effects</span></span>
<span><span class="co">## Saving original plotting parameters</span></span>
<span><span class="va">original_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>no.readonly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Adjusting plotting grid</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>  </span>
<span></span>
<span><span class="co">## The plots to show sampling bias effects</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bias</span>, main <span class="op">=</span> <span class="st">"Bias file"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/explore_calibration_geo.html">explore_calibration_geo</a></span><span class="op">(</span><span class="va">d</span>, raster_variables <span class="op">=</span> <span class="va">var</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                        main <span class="op">=</span> <span class="st">"Random Background"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/explore_calibration_geo.html">explore_calibration_geo</a></span><span class="op">(</span><span class="va">d_bias_direct</span>, raster_variables <span class="op">=</span> <span class="va">var</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                        main <span class="op">=</span> <span class="st">"Direct Bias Effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/explore_calibration_geo.html">explore_calibration_geo</a></span><span class="op">(</span><span class="va">d_bias_inverse</span>, raster_variables <span class="op">=</span> <span class="va">var</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                        main <span class="op">=</span> <span class="st">"Inverse Bias Effect"</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/bias%20data-1.png" width="672"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">original_par</span><span class="op">)</span>  <span class="co"># Reset grid</span></span></code></pre></div>
<p>Note that when the bias effect is “direct”, the majority of the
background points are sampled from the borders of the calibration area,
corresponding to higher bias values. Conversely, with an “inverse” bias
effect, most background points are selected from the center, where bias
values are lower.</p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="pca-for-variables">PCA for variables<a class="anchor" aria-label="anchor" href="#pca-for-variables"></a>
</h3>
<p>A common approach in ENM involves summarizing the information from a
set of predictor variables into a smaller set of uncorrelated variables
using Principal Component Analysis (PCA) (see <a href="https://doi.org/10.7550/rmb.36723" class="external-link">Cruz-Cardenaz et al. 2014</a>
for an example). In <strong>kuenm2</strong> users can perform a PCA
internally or use variables that have been externally prepared as
PCs.</p>
<div class="section level4">
<h4 id="internal-pca">Internal PCA<a class="anchor" aria-label="anchor" href="#internal-pca"></a>
</h4>
<p><strong>kuenm2</strong> can perform all PCA transformations
internally, eliminating the need to prepare the new PC variables for
each scenario of projection. This is particularly advantageous when
projecting model results across multiple time scenarios (e.g., various
Global Climate Models for different future periods). By performing PCA
internally, you only need to store the raw environmental variables
(e.g., <code>bio_1</code>, <code>bio_2</code>, etc.) on your directory,
and the functions will handle the PCA transformation as needed.</p>
<p>Let’s explore how to implement this:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data for maxnet models using PCA parameters</span></span>
<span><span class="va">d_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                      occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                      x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                      raster_variables <span class="op">=</span> <span class="va">var</span>, </span>
<span>                      do_pca <span class="op">=</span> <span class="cn">TRUE</span>, center <span class="op">=</span> <span class="cn">TRUE</span>, scale <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># PCA parameters</span></span>
<span>                      species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                      categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                      n_background <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                      features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                      r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 43 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span>
<span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">d_pca</span><span class="op">)</span></span>
<span><span class="co">#&gt; prepared_data object summary</span></span>
<span><span class="co">#&gt; ============================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of Records: 1008 </span></span>
<span><span class="co">#&gt;   - Presence: 51 </span></span>
<span><span class="co">#&gt;   - Background: 957 </span></span>
<span><span class="co">#&gt; Training-Testing Method:</span></span>
<span><span class="co">#&gt;   - k-fold Cross-validation: 4 folds</span></span>
<span><span class="co">#&gt; Continuous Variables:</span></span>
<span><span class="co">#&gt;   - bio_1, bio_7, bio_12, bio_15 </span></span>
<span><span class="co">#&gt; Categorical Variables:</span></span>
<span><span class="co">#&gt;   - SoilType </span></span>
<span><span class="co">#&gt; PCA Information:</span></span>
<span><span class="co">#&gt;   - Variables included: bio_1, bio_7, bio_12, bio_15 </span></span>
<span><span class="co">#&gt;   - Number of PCA components: 4 </span></span>
<span><span class="co">#&gt; Weights: No weights provided</span></span>
<span><span class="co">#&gt; Calibration Parameters:</span></span>
<span><span class="co">#&gt;   - Algorithm: maxnet </span></span>
<span><span class="co">#&gt;   - Number of candidate models: 610 </span></span>
<span><span class="co">#&gt;   - Features classes (responses): l, q, p, lq, lqp </span></span>
<span><span class="co">#&gt;   - Regularization multipliers: 0.1, 1, 2, 3, 5</span></span></code></pre></div>
<p><br></p>
<p>The elements calibration data and formula grid have now been
generated considering the principal components (PCs). By default, all
continuous variables were included in the PCA, while categorical
variables (e.g., “SoilType”) were excluded. The default settings for the
number of PCs selected retain the axes that collectively explain 95% of
the total variance, and then further filter these, keeping only those
axes that individually explain at least 5% of the variance. These
parameters can be changed using other arguments in the function
<code>prepare_data</code></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check calibration data</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d_pca</span><span class="op">$</span><span class="va">calibration_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   pr_bg         PC1        PC2        PC3         PC4 SoilType</span></span>
<span><span class="co">#&gt; 1     1  1.48690341 1.01252697  0.1180156 -0.09119257       19</span></span>
<span><span class="co">#&gt; 2     1  1.46028074 0.17701144  1.1573461 -0.12326796       19</span></span>
<span><span class="co">#&gt; 3     1  0.82676494 1.21965795  0.8145129 -0.67588891        6</span></span>
<span><span class="co">#&gt; 4     1  0.62680441 0.03967459  0.1525997  0.18784282        1</span></span>
<span><span class="co">#&gt; 5     1  0.94584897 0.93302089  1.4382424 -0.03192094       19</span></span>
<span><span class="co">#&gt; 7     1 -0.07597437 1.55268331 -0.2007953 -0.98153204        6</span></span>
<span></span>
<span><span class="co"># Check formula grid</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d_pca</span><span class="op">$</span><span class="va">formula_grid</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ID      Formulas R_multiplier Features</span></span>
<span><span class="co">#&gt; 1  1 ~PC1 + PC2 -1          0.1        l</span></span>
<span><span class="co">#&gt; 2  2 ~PC1 + PC2 -1          1.0        l</span></span>
<span><span class="co">#&gt; 3  3 ~PC1 + PC2 -1          2.0        l</span></span>
<span><span class="co">#&gt; 4  4 ~PC1 + PC2 -1          3.0        l</span></span>
<span><span class="co">#&gt; 5  5 ~PC1 + PC2 -1          5.0        l</span></span>
<span><span class="co">#&gt; 6  6 ~PC1 + PC3 -1          5.0        l</span></span>
<span></span>
<span><span class="co"># Explore variables distribution</span></span>
<span><span class="va">calib_hist_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explore_calibration_hist.html">explore_calibration_hist</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d_pca</span>, raster_variables <span class="op">=</span> <span class="va">var</span>,</span>
<span>                                           include_m <span class="op">=</span> <span class="cn">TRUE</span>, breaks <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_explore_calibration.html">plot_explore_calibration</a></span><span class="op">(</span>explore_calibration <span class="op">=</span> <span class="va">calib_hist_pca</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/explore%20hist-1.png" width="672"></p>
<p>As the PCA was performed internally, the <code>prepared_data</code>
object contains all the necessary information to transform the raw
environmental variables into the required PCs <strong>This means that
when predicting or projecting models, users should provide raw raster
variables</strong>, and the PCs will be obtained internally in the
function.</p>
<p><br></p>
</div>
<div class="section level4">
<h4 id="external-pca">External PCA<a class="anchor" aria-label="anchor" href="#external-pca"></a>
</h4>
<p>Alternatively, users can perform a PCA with their data by using the
<code><a href="../reference/perform_pca.html">perform_pca()</a></code> function, or one of their preference. See
full documentation with <code><a href="../reference/perform_pca.html">help(perform_pca)</a></code>. Se an example
with <code><a href="../reference/perform_pca.html">perform_pca()</a></code> below:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pca_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/perform_pca.html">perform_pca</a></span><span class="op">(</span>raster_variables <span class="op">=</span> <span class="va">var</span>, exclude_from_pca <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                       center <span class="op">=</span> <span class="cn">TRUE</span>, scale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pca_var</span><span class="op">$</span><span class="va">env</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare_data_files/figure-html/do%20PCA-1.png" width="672"></p>
<p><br></p>
<p>Now, let’s use the PCs generated by <code><a href="../reference/perform_pca.html">perform_pca()</a></code> to
prepare the data:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data for maxnet model using PCA variables</span></span>
<span><span class="va">d_pca_extern</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                             occ <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>                             x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>                             raster_variables <span class="op">=</span> <span class="va">pca_var</span><span class="op">$</span><span class="va">env</span>,  <span class="co"># Output of perform_pca()</span></span>
<span>                             do_pca <span class="op">=</span> <span class="cn">FALSE</span>,  <span class="co"># Set to FALSE because variables are PCs</span></span>
<span>                             species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                             categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                             n_background <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                             features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                             r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in handle_missing_data(occ_bg, weights): 43 rows were excluded from</span></span>
<span><span class="co">#&gt; database because NAs were found.</span></span>
<span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">d_pca_extern</span><span class="op">)</span></span>
<span><span class="co">#&gt; prepared_data object summary</span></span>
<span><span class="co">#&gt; ============================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of Records: 1008 </span></span>
<span><span class="co">#&gt;   - Presence: 51 </span></span>
<span><span class="co">#&gt;   - Background: 957 </span></span>
<span><span class="co">#&gt; Training-Testing Method:</span></span>
<span><span class="co">#&gt;   - k-fold Cross-validation: 4 folds</span></span>
<span><span class="co">#&gt; Continuous Variables:</span></span>
<span><span class="co">#&gt;   - PC1, PC2, PC3, PC4 </span></span>
<span><span class="co">#&gt; Categorical Variables:</span></span>
<span><span class="co">#&gt;   - SoilType </span></span>
<span><span class="co">#&gt; PCA Information: PCA not performed</span></span>
<span><span class="co">#&gt; Weights: No weights provided</span></span>
<span><span class="co">#&gt; Calibration Parameters:</span></span>
<span><span class="co">#&gt;   - Algorithm: maxnet </span></span>
<span><span class="co">#&gt;   - Number of candidate models: 610 </span></span>
<span><span class="co">#&gt;   - Features classes (responses): l, q, p, lq, lqp </span></span>
<span><span class="co">#&gt;   - Regularization multipliers: 0.1, 1, 2, 3, 5</span></span></code></pre></div>
<p><br></p>
<p>Note that since PCA was performed externally,
<code>do_pca = FALSE</code> is set within the <code>prepare_data</code>
function. This is crucial because setting it to <code>TRUE</code> would
incorrectly apply PCA to variables that are <em>already</em> PCs.
Consequently, the <code>prepared_data</code> object in this scenario
does not store any PCA-related information. This means that when users
predict or project models, they must <strong>must provide the
PCs</strong> instead of the raw raster variables.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check calibration data</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d_pca_extern</span><span class="op">$</span><span class="va">calibration_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   pr_bg         PC1        PC2        PC3         PC4 SoilType</span></span>
<span><span class="co">#&gt; 1     1  1.48690341 1.01252697  0.1180156 -0.09119257       19</span></span>
<span><span class="co">#&gt; 2     1  1.46028074 0.17701144  1.1573461 -0.12326796       19</span></span>
<span><span class="co">#&gt; 3     1  0.82676494 1.21965795  0.8145129 -0.67588891        6</span></span>
<span><span class="co">#&gt; 4     1  0.62680441 0.03967459  0.1525997  0.18784282        1</span></span>
<span><span class="co">#&gt; 5     1  0.94584897 0.93302089  1.4382424 -0.03192094       19</span></span>
<span><span class="co">#&gt; 7     1 -0.07597437 1.55268331 -0.2007953 -0.98153204        6</span></span>
<span></span>
<span><span class="co"># Check formula grid</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d_pca_extern</span><span class="op">$</span><span class="va">formula_grid</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ID      Formulas R_multiplier Features</span></span>
<span><span class="co">#&gt; 1  1 ~PC1 + PC2 -1          0.1        l</span></span>
<span><span class="co">#&gt; 2  2 ~PC1 + PC2 -1          1.0        l</span></span>
<span><span class="co">#&gt; 3  3 ~PC1 + PC2 -1          2.0        l</span></span>
<span><span class="co">#&gt; 4  4 ~PC1 + PC2 -1          3.0        l</span></span>
<span><span class="co">#&gt; 5  5 ~PC1 + PC2 -1          5.0        l</span></span>
<span><span class="co">#&gt; 6  6 ~PC1 + PC3 -1          5.0        l</span></span></code></pre></div>
<p><br></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="prepare-user-pre-processed-data">Prepare user pre-processed data<a class="anchor" aria-label="anchor" href="#prepare-user-pre-processed-data"></a>
</h2>
<p>If users already have data that has been prepared for calibration,
they can use the <code><a href="../reference/prepare_user_data.html">prepare_user_data()</a></code> function to create the
object required for model calibration. User-prepared calibration data
must be a <code>data.frame</code> that includes a column indicating
<strong>presence (1)</strong> and <strong>background (0)</strong>
records, along with columns with values for each of your
<strong>variables</strong>. The package includes an example of such a
<code>data.frame</code> for reference. See an example of its use
below:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"user_data"</span>, package <span class="op">=</span> <span class="st">"kuenm2"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">user_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   pr_bg    bio_1    bio_7 bio_12   bio_15 SoilType</span></span>
<span><span class="co">#&gt; 1     1 16.49046 18.66075   1778 12.96107       19</span></span>
<span><span class="co">#&gt; 2     1 15.46644 19.65775   1560 14.14697       19</span></span>
<span><span class="co">#&gt; 3     1 15.70560 17.99450   1652 23.27548        6</span></span>
<span><span class="co">#&gt; 4     1 17.78899 19.55600   1597 18.91694        1</span></span>
<span><span class="co">#&gt; 5     1 15.50116 18.30750   1497 15.39440       19</span></span>
<span><span class="co">#&gt; 7     1 17.42421 17.25875   1760 34.17664        6</span></span></code></pre></div>
<p><br></p>
<p>The <code><a href="../reference/prepare_user_data.html">prepare_user_data()</a></code> function operates similarly to
<code><a href="../reference/prepare_data.html">prepare_data()</a></code>, but with a key difference; instead of
requiring a <code>data.frame</code> of occurrence coordinates and a
<code>SpatRaster</code> of predictor variables, it takes your already
prepared user <code>data.frame</code> (see below). See full
documentation with <code><a href="../reference/prepare_user_data.html">help(prepare_user_data)</a></code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data for maxnet model</span></span>
<span><span class="va">data_user</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_user_data.html">prepare_user_data</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"maxnet"</span>,</span>
<span>                               user_data <span class="op">=</span> <span class="va">user_data</span>,  <span class="co"># user-prepared data.frame</span></span>
<span>                               pr_bg <span class="op">=</span> <span class="st">"pr_bg"</span>,</span>
<span>                               species <span class="op">=</span> <span class="st">"Myrcia hatschbachii"</span>,</span>
<span>                               categorical_variables <span class="op">=</span> <span class="st">"SoilType"</span>,</span>
<span>                               features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"q"</span>, <span class="st">"p"</span>, <span class="st">"lq"</span>, <span class="st">"lqp"</span><span class="op">)</span>,</span>
<span>                               r_multiplier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_user</span> </span>
<span><span class="co">#&gt; prepared_data object summary</span></span>
<span><span class="co">#&gt; ============================</span></span>
<span><span class="co">#&gt; Species: Myrcia hatschbachii </span></span>
<span><span class="co">#&gt; Number of Records: 527 </span></span>
<span><span class="co">#&gt;   - Presence: 51 </span></span>
<span><span class="co">#&gt;   - Background: 476 </span></span>
<span><span class="co">#&gt; Training-Testing Method:</span></span>
<span><span class="co">#&gt;   - k-fold Cross-validation: 4 folds</span></span>
<span><span class="co">#&gt; Continuous Variables:</span></span>
<span><span class="co">#&gt;   - bio_1, bio_7, bio_12, bio_15 </span></span>
<span><span class="co">#&gt; Categorical Variables:</span></span>
<span><span class="co">#&gt;   - SoilType </span></span>
<span><span class="co">#&gt; PCA Information: PCA not performed</span></span>
<span><span class="co">#&gt; Weights: No weights provided</span></span>
<span><span class="co">#&gt; Calibration Parameters:</span></span>
<span><span class="co">#&gt;   - Algorithm: maxnet </span></span>
<span><span class="co">#&gt;   - Number of candidate models: 610 </span></span>
<span><span class="co">#&gt;   - Features classes (responses): l, q, p, lq, lqp </span></span>
<span><span class="co">#&gt;   - Regularization multipliers: 0.1, 1, 2, 3, 5</span></span></code></pre></div>
<p>This function also allows you to provide a list of folds for
cross-validation to be used during model calibration. If
<code>user_folds</code> is <code>NULL</code>, the function will
automatically split your data based on the number of folds specified by
the <code>kfolds</code> argument. Internal PCA for variables is also
available with this function.</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="saving-a-prepared_data-object">Saving a prepared_data object<a class="anchor" aria-label="anchor" href="#saving-a-prepared_data-object"></a>
</h2>
<p>The <code>prepared_data</code> object is crucial for the next step in
the ENM workflow in <strong>kuenm2</strong>, model calibration. As this
object is essentially a list, users can save it to a local directory
using <code><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">saveRDS()</a></code>. Saving the object facilitates loading it
back into your R session later using <code><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS()</a></code>. See an
example below:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set directory to save (here, in a temporary directory)</span></span>
<span><span class="va">dir_to_save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save the data</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">d</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_to_save</span>, <span class="st">"Data.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Import data</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_to_save</span>, <span class="st">"Data.rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Marlon E. Cobos, Weverton Trindade, Luis F. Arias-Giraldo, Luis Osorio-Olvera, A. Townsend Peterson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
